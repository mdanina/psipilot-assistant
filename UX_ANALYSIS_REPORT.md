# Анализ эффективности платформы PsiPilot Assistant
## Отчёт по пользовательскому опыту (UX) и выявленные проблемы

---

## Содержание
1. [Общая оценка](#1-общая-оценка)
2. [Критические проблемы UX](#2-критические-проблемы-ux)
3. [Конфликтующие сценарии](#3-конфликтующие-сценарии)
4. [Проблемы по разделам](#4-проблемы-по-разделам)
5. [Рекомендации по улучшению](#5-рекомендации-по-улучшению)
6. [Приоритизированный план действий](#6-приоритизированный-план-действий)

---

## 1. Общая оценка

### Сильные стороны платформы:
- **Надёжное локальное хранилище** - записи сохраняются локально и восстанавливаются при потере связи
- **Блокировка навигации** - предупреждение при попытке уйти во время записи
- **Автоматическое восстановление транскрипций** - система отслеживает незавершённые транскрипции
- **Шифрование данных** - защита чувствительной информации пациентов
- **Адаптивный дизайн** - поддержка мобильных устройств

### Области требующие внимания:
- Разрозненность пользовательских потоков
- Неочевидные связи между разделами
- Избыточная сложность некоторых сценариев
- Отсутствие онбординга для новых пользователей

---

## 2. Критические проблемы UX

### 2.1. Разрыв между записью и привязкой к пациенту

**Файл:** `src/pages/ScribePage.tsx:263-267`

```typescript
const session = await createSession({
  userId: user.id,
  clinicId: profile.clinic_id,
  patientId: null, // Will be linked later on Sessions page
  title: `Сессия ${new Date().toLocaleString('ru-RU')}`,
});
```

**Проблема:**
- Запись создаётся БЕЗ привязки к пациенту
- Пользователь должен вручную переходить в "Сессии" для привязки
- Нет напоминания о непривязанных записях

**Решение:**
```typescript
// Вариант 1: Диалог выбора пациента ПЕРЕД записью
// Вариант 2: Диалог привязки СРАЗУ после остановки записи
// Вариант 3: Индикатор непривязанных сессий в сайдбаре
```

---

### 2.2. ~~Session Timeout во время активной записи~~ (ИСПРАВЛЕНО)

**Файлы:** `src/pages/ScribePage.tsx`, `src/pages/SessionsPage.tsx`

**Статус:** ИСПРАВЛЕНО

Добавлена защита от session timeout во время активной записи:

```typescript
// Обновление activity во время записи для предотвращения session timeout
useEffect(() => {
  if (!isRecording) return;

  // Обновляем activity каждые 30 секунд во время записи
  const intervalId = setInterval(() => {
    updateActivity();
  }, 30000);

  // Также обновляем сразу при начале записи
  updateActivity();

  return () => {
    clearInterval(intervalId);
  };
}, [isRecording, updateActivity]);
```

Также защита для транскрипций реализована в `useTranscriptionRecovery.ts:137-138`.

---

### 2.3. Потеря данных при закрытии вкладки незавершённой сессии

**Файл:** `src/pages/SessionsPage.tsx:1169-1173`

```typescript
if (!session.patient_id) {
  // If not linked, show dialog - user must link or delete
  setClosingSessionId(sessionId);
  setCloseSessionDialogOpen(true);
}
```

**Проблема:**
- При закрытии вкладки браузера диалог не показывается
- Сессия без пациента остаётся "подвешенной"
- Нет механизма напоминания о незавершённых сессиях

**Решение:**
- Добавить `beforeunload` handler на уровне приложения
- Показывать badge с количеством незавершённых сессий
- Email-уведомления о забытых сессиях

---

### 2.4. Дублирование логики записи

**Проблема:**
Запись аудио реализована в ДВУХ местах с разной логикой:
- `src/pages/ScribePage.tsx` - главная страница
- `src/pages/SessionsPage.tsx` - страница сессий

Это создаёт:
- Несогласованность поведения
- Сложность поддержки кода
- Путаницу у пользователей

**Решение:**
Создать единый компонент `RecordingManager` с централизованной логикой.

---

## 3. Конфликтующие сценарии

### 3.1. Конфликт: Два пути к одной цели

```
Путь 1: ScribePage → Запись → Сессии → Привязка к пациенту
Путь 2: Календарь → Встреча → Сессии → Запись → Привязка (уже есть)
Путь 3: Пациент → Активности → Сессии → Запись
```

**Проблема:** Пользователь не понимает оптимальный путь. Разные пути приводят к разному состоянию сессии.

**Решение:**
- Унифицировать точки входа
- Добавить туториал при первом использовании
- Рекомендовать оптимальный путь в UI

---

### 3.2. Конфликт: Специалист vs Администратор в календаре

**Файл:** `src/pages/CalendarPage.tsx:67-111`

```typescript
// Для admin: load all patients in clinic
// Для specialist: load only assigned patients
if (profile.role === 'admin') {
  const result = await getPatients();
} else {
  const result = await getAssignedPatients();
}
```

**Проблема:**
- Администратор может создать встречу с пациентом, не назначенным врачу
- При назначении врачу автоматически создаётся assignment (строка 182-194)
- Врач получает уведомление? НЕТ - не реализовано

**Решение:**
- Добавить систему уведомлений
- Показывать предупреждение администратору перед назначением

---

### 3.3. Конфликт: Транскрипция без сети

**Файл:** `src/pages/ScribePage.tsx:316-325`

```typescript
try {
  await startTranscription(recording.id, transcriptionApiUrl);
  // ...
} catch (transcriptionError) {
  toast({
    title: "Предупреждение",
    description: "Сессия сохранена, но транскрипция не запущена...",
    variant: "default",
  });
}
```

**Проблема:**
- Транскрипция требует сеть, но запись работает offline
- Нет механизма автозапуска транскрипции при восстановлении связи
- Пользователь может забыть запустить транскрипцию вручную

**Решение:**
- Очередь транскрипций с автоматическим retry
- Push-уведомление о готовности к транскрипции

---

### 3.4. Конфликт: Удаление пациента с активными сессиями

**Файл:** `src/pages/PatientsPage.tsx:98-121`

```typescript
deletePatientMutation.mutate(deletingPatientId, {
  onSuccess: () => {
    toast({
      title: "Успешно",
      description: "Пациент удален",
    });
  },
});
```

**Проблема:**
- Нет проверки связанных сессий перед удалением
- Возможна потеря данных сессий
- Нет soft delete с возможностью восстановления

**Решение:**
- Добавить проверку зависимостей
- Показывать предупреждение с количеством связанных записей
- Использовать soft delete (поле `deleted_at` уже есть)

---

## 4. Проблемы по разделам

### 4.1. Страница записи (ScribePage)

| Проблема | Влияние | Приоритет |
|----------|---------|-----------|
| Нет выбора пациента перед записью | Высокое | P0 |
| Нет индикации длительности до max | Среднее | P2 |
| Кнопка "Транскрибировать" неактивна без записи | Низкое | P3 |
| Нет подсказки о разрешении микрофона | Среднее | P1 |

---

### 4.2. Страница сессий (SessionsPage)

| Проблема | Влияние | Приоритет |
|----------|---------|-----------|
| Лимит 50 сессий без пагинации | Высокое | P1 |
| Сложная логика вкладок | Высокое | P1 |
| Нет фильтрации по дате/статусу | Среднее | P2 |
| Поиск сессий только по названию | Среднее | P2 |
| Нет группировки по пациентам | Низкое | P3 |

**Файл:** `src/pages/SessionsPage.tsx:78` - лимит сессий
```typescript
const {
  data: sessions = [],
  isLoading: isLoadingSessions,
  error: sessionsError
} = useSessions(stableClinicId); // Внутри ограничено 50 записями
```

---

### 4.3. Страница пациентов (PatientsPage)

| Проблема | Влияние | Приоритет |
|----------|---------|-----------|
| Нет пагинации при большом количестве | Высокое | P1 |
| Email клик открывает mailto (неудобно) | Низкое | P3 |
| Нет быстрых действий (создать сессию) | Среднее | P2 |
| Удаление без подтверждения связей | Высокое | P0 |

---

### 4.4. Календарь (CalendarPage)

| Проблема | Влияние | Приоритет |
|----------|---------|-----------|
| Нет drag-and-drop для встреч | Среднее | P2 |
| Кнопка синхронизации неактивна | Среднее | P2 |
| Нет проверки конфликтов времени | Высокое | P1 |
| Повторяющиеся встречи без даты окончания | Среднее | P2 |

**Файл:** `src/pages/CalendarPage.tsx:282-287`
```typescript
const handleSyncClick = () => {
  toast({
    title: "Синхронизация",
    description: "Синхронизация с внешними календарями будет доступна в будущих обновлениях",
  });
};
```

---

### 4.5. Аутентификация и онбординг

| Проблема | Влияние | Приоритет |
|----------|---------|-----------|
| Нет регистрации (только инвайты) | Среднее | P2 |
| Ссылка "/register" ведёт в никуда | Высокое | P0 |
| Онбординг только для создателя клиники | Среднее | P1 |
| Нет туториала для новых пользователей | Высокое | P1 |

**Файл:** `src/pages/LoginPage.tsx:127-129`
```typescript
<Link to="/register" className="text-primary hover:underline">
  Свяжитесь с администратором
</Link>
// ПРОБЛЕМА: /register не существует!
```

---

### 4.6. Профиль и настройки

| Проблема | Влияние | Приоритет |
|----------|---------|-----------|
| MFA без recovery codes | Высокое | P0 |
| Нет настройки уведомлений | Среднее | P2 |
| Таймзона выбирается только в календаре | Низкое | P3 |

---

## 5. Рекомендации по улучшению

### 5.1. Критические (P0) - немедленное исправление

#### 5.1.1. Добавить выбор пациента перед записью

```tsx
// В ScribePage добавить опциональный выбор пациента
<RecordingCard
  onPatientSelect={(patientId) => setSelectedPatient(patientId)}
  selectedPatient={selectedPatient}
  // ...
/>
```

#### 5.1.2. Исправить ссылку регистрации

```tsx
// LoginPage.tsx - заменить нерабочую ссылку
<p className="text-center text-sm text-muted-foreground">
  Нет аккаунта?{' '}
  <span className="text-muted-foreground">
    Обратитесь к администратору вашей клиники для получения приглашения
  </span>
</p>
```

#### 5.1.3. Проверка зависимостей при удалении пациента

```typescript
// PatientsPage.tsx
const handleDeleteClick = async (e: React.MouseEvent, patientId: string) => {
  e.stopPropagation();

  // Проверить связанные данные
  const { count: sessionsCount } = await supabase
    .from('sessions')
    .select('*', { count: 'exact', head: true })
    .eq('patient_id', patientId);

  if (sessionsCount > 0) {
    setWarningMessage(`У пациента ${sessionsCount} сессий. Они также будут удалены.`);
  }

  setDeletingPatientId(patientId);
  setDeleteDialogOpen(true);
};
```

---

### 5.2. Высокий приоритет (P1)

#### 5.2.1. ~~Предотвратить logout во время записи~~ (ИСПРАВЛЕНО)

Реализовано в `ScribePage.tsx` и `SessionsPage.tsx`:

```typescript
// Обновление activity во время записи для предотвращения session timeout
useEffect(() => {
  if (!isRecording) return;
  const intervalId = setInterval(() => updateActivity(), 30000);
  updateActivity();
  return () => clearInterval(intervalId);
}, [isRecording, updateActivity]);
```

#### 5.2.2. Добавить пагинацию для сессий

```typescript
// useSessions.ts
export function useSessions(clinicId: string | undefined, page = 1, limit = 50) {
  return useQuery({
    queryKey: ['sessions', clinicId, page, limit],
    queryFn: () => getSessions(clinicId, page, limit),
    // ...
  });
}
```

#### 5.2.3. Онбординг для приглашённых пользователей

```tsx
// Новый компонент WelcomeTour.tsx
export function WelcomeTour() {
  const steps = [
    { target: '[data-tour="record"]', content: 'Начните запись здесь' },
    { target: '[data-tour="patients"]', content: 'Управляйте пациентами' },
    // ...
  ];
  return <TourGuide steps={steps} />;
}
```

---

### 5.3. Средний приоритет (P2)

#### 5.3.1. Уведомления о назначении пациента

```typescript
// supabase-patient-assignments.ts
export async function assignPatientToDoctor(
  patientId: string,
  doctorId: string,
  type: string
) {
  const result = await supabase
    .from('patient_assignments')
    .insert({ patient_id: patientId, doctor_id: doctorId, assignment_type: type });

  // Создать уведомление
  await supabase
    .from('notifications')
    .insert({
      user_id: doctorId,
      type: 'patient_assigned',
      data: { patient_id: patientId },
    });

  return result;
}
```

#### 5.3.2. Проверка конфликтов времени в календаре

```typescript
// CreateAppointmentDialog.tsx
const checkConflicts = async (scheduledAt: string, durationMinutes: number) => {
  const endTime = new Date(new Date(scheduledAt).getTime() + durationMinutes * 60000);

  const { data: conflicts } = await supabase
    .from('sessions')
    .select('*')
    .eq('user_id', selectedDoctorId)
    .gte('scheduled_at', scheduledAt)
    .lte('scheduled_at', endTime.toISOString());

  return conflicts?.length > 0;
};
```

---

### 5.4. Низкий приоритет (P3)

- Группировка сессий по пациентам
- Drag-and-drop в календаре
- Перенос таймзоны в глобальные настройки

---

## 6. Приоритизированный план действий

### Фаза 1: Критические исправления
1. Исправить ссылку регистрации → `/login`
2. Добавить проверку зависимостей при удалении пациента
3. Предотвратить logout во время записи
4. Добавить MFA recovery codes

### Фаза 2: Улучшение основных потоков
1. Опциональный выбор пациента перед записью
2. Индикатор непривязанных сессий
3. Пагинация для списков (пациенты, сессии)
4. Проверка конфликтов времени в календаре

### Фаза 3: Улучшение UX
1. Онбординг-тур для новых пользователей
2. Система уведомлений
3. Автоматический retry транскрипции
4. Фильтрация и поиск по сессиям

### Фаза 4: Дополнительные возможности
1. Синхронизация с внешними календарями
2. Drag-and-drop в календаре
3. Расширенная аналитика
4. Push-уведомления

---

## Заключение

Платформа PsiPilot Assistant имеет прочную техническую основу с хорошо продуманной архитектурой безопасности и offline-функциональностью. Однако пользовательский опыт страдает от:

1. **Разрозненности потоков** - пользователь должен переключаться между разделами для выполнения связанных задач
2. **Отсутствия guidance** - новым пользователям сложно понять оптимальные пути использования
3. **Недостаточной обратной связи** - система не напоминает о незавершённых действиях

Реализация предложенных улучшений значительно повысит удобство использования и снизит когнитивную нагрузку на пользователей.

---

*Отчёт сгенерирован: 2026-01-18*
*Версия анализа: 1.0*
