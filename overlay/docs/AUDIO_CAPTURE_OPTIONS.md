# Варианты захвата звука для overlay

## Проблема

`getDisplayMedia` с «Поделиться звуком» часто даёт пустой или почти пустой поток: браузер создаёт трек, но реального аудио мало. Остановка видео и запись только аудио на части систем может это усугублять.

## Рабочие подходы (как делают «нормальные» захватчики)

### 1. Virtual Audio Cable + «Микрофон» (реализовано в overlay)

**Идея:** Системный звук направляется в виртуальное устройство, которое в ОС выглядит как микрофон. Приложение пишет с «микрофона» через `getUserMedia` — на самом деле получает системный звук.

**Как настроить (разово):**
- **Windows:** [VB-Audio Cable](https://vb-audio.com/Cable/) (бесплатно). Установить → «CABLE Input» как устройство воспроизведения по умолчанию (или вручную направлять туда звук созвона) → «CABLE Output» появляется как микрофон.
- **macOS:** [BlackHole](https://github.com/ExistentialAudio/BlackHole) (бесплатно). Создать Multi-Output Device: вывод приложения + BlackHole → BlackHole виден как вход.

**В overlay:** Выбор устройства ввода для «Микрофон». Пользователь выбирает «CABLE Output» / «BlackHole» — запись идёт с системного звука. Никаких табов, getDisplayMedia, только `getUserMedia` + выбор deviceId.

**Плюсы:** Стабильно, тот же код, что и для микрофона.  
**Минусы:** Нужна одноразовая настройка ОС и, при желании системного звука, перенаправление вывода в cable.

---

### 2. Tauri-плагин с WASAPI loopback (Windows)

**Идея:** Нативный код на Rust через [WASAPI](https://learn.microsoft.com/en-us/windows/win32/coreaudio/loopback-recording) в режиме loopback напрямую захватывает «всё, что играет» в устройстве воспроизведения. Overlay — Tauri, можно добавить кастомный плагин.

**Реализация:** Библиотека [wasapi-rs](https://github.com/HEnquist/wasapi-rs) или собственный плагин. В плагине: выбор rendering endpoint → loopback capture → PCM (или WAV) → отдача во фронт или сохранение файла.

**Плюсы:** Настоящий системный захват, без VB-Cable, только Windows.  
**Минусы:** Только Windows; нужна разработка и поддержка плагина; macOS/Linux — отдельные решения (BlackHole, PipeWire и т.д.).

---

### 3. Запись «экран + звук», извлечение аудио на бэке

**Идея:** Не останавливать видео при `getDisplayMedia`. Писать в MediaRecorder и видео, и аудио (один stream), загружать WebM на бэк. На бэке ffmpeg извлекает только аудио и отдаёт в транскрипцию.

**Плюсы:** Обходим ситуацию «остановка видео = пропажа звука»; всё в браузере, без нативных плагинов.  
**Минусы:** Больше трафика (видео), нужен ffmpeg на бэке и доработка пайплайна.

---

### 4. tauri-plugin-mic-recorder (микрофон)

**Идея:** [tauri-plugin-mic-recorder](https://github.com/ayangweb/tauri-plugin-mic-recorder) (cpal + hound) пишет с микрофона в WAV на диск. Можно использовать для режима «Микрофон» вместо Web MediaRecorder.

**Плюсы:** Нативная запись, может быть стабильнее в edge-cases.  
**Минусы:** Только микрофон; для системного звука по‑прежнему Virtual Cable или loopback.

---

## Рекомендация

- **Сейчас:** Режим «Микрофон» + **выбор устройства ввода**. Пользователь ставит VB-Cable/BlackHole, направляет туда системный звук, в overlay выбирает это устройство — получаем по сути «захват системного звука» без getDisplayMedia.
- **Дальше:** При необходимости «настоящего» loopback на Windows — Tauri-плагин с WASAPI; для унификации с табом/экран-шарингом — вариант 3 (video+audio → ffmpeg).
