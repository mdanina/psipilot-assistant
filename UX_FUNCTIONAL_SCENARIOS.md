# Анализ функциональных сценариев PsiPilot Assistant
## Критические проблемы пользовательских потоков

---

## Содержание
1. [Запись и транскрипция](#1-запись-и-транскрипция)
2. [Работа с пациентами](#2-работа-с-пациентами)
3. [Календарь и встречи](#3-календарь-и-встречи)
4. [Авторизация и роли](#4-авторизация-и-роли)
5. [Сводная таблица](#5-сводная-таблица)

---

## 1. Запись и транскрипция

### 1.1. КРИТИЧНО: Потеря записи при частичном сохранении

**Файлы:** `ScribePage.tsx:299-354`, `SessionsPage.tsx:1651-1702`

**Сценарий:**
```
1. Врач завершает запись сессии
2. IndexedDB заполнен → локальное сохранение FAIL
3. Supabase upload → SUCCESS
4. Браузер падает ДО завершения транскрипции
5. РЕЗУЛЬТАТ: Запись потеряна (нет локальной копии, транскрипция не завершена)
```

**Влияние:** Врач теряет важную медицинскую запись без возможности восстановления.

---

### 1.2. КРИТИЧНО: Deadlock при остановке записи

**Файл:** `useAudioRecorder.ts:215-231`

```typescript
const stopRecording = useCallback((): Promise<Blob | null> => {
  return new Promise((resolve) => {
    stopResolveRef.current = resolve;
    mediaRecorder.stop();
    // БЕЗ ТАЙМАУТА!
  });
}, ...);
```

**Сценарий:**
```
1. Врач нажимает "Остановить запись"
2. mediaRecorder.stop() вызван
3. mediaRecorder.onstop НЕ срабатывает (баг браузера)
4. Promise НИКОГДА не resolve
5. UI зависает на "Завершение записи..."
6. Врач вынужден перезагрузить страницу → потеря записи
```

**Решение:** Добавить timeout (10 сек) с fallback на resolve(null).

---

### 1.3. КРИТИЧНО: Транскрипция зависает навсегда

**Файл:** `useTranscriptionRecovery.ts:123-134`

**Сценарий:**
```
1. Врач загружает запись
2. Транскрипция запускается в AssemblyAI
3. AssemblyAI зависает (редко, но бывает)
4. После 150 попыток (2 часа) polling прекращается
5. Транскрипция УДАЛЯЕТСЯ из UI
6. НО в БД статус остаётся "processing" НАВСЕГДА
7. Врач не понимает что произошло, запись "исчезла"
```

**Проблема:** Нет способа:
- Отменить зависшую транскрипцию
- Перезапустить транскрипцию вручную
- Увидеть что транскрипция "зависла"

---

### 1.4. ВЫСОКИЙ: Дублирование транскрипции при double-click

**Файлы:** `RecordingCard.tsx:129-149`, `transcribe.js:189-320`

**Сценарий:**
```
1. Врач нажимает "Транскрибировать"
2. Запрос уходит в API, создаётся transcript_id = "abc123"
3. Кнопка НЕ disabled → врач нажимает ещё раз
4. Создаётся ВТОРОЙ transcript_id = "xyz789"
5. В БД сохраняется только последний transcript_id
6. Первая транскрипция потеряна в AssemblyAI (платные минуты!)
```

---

### 1.5. ВЫСОКИЙ: Checkpoint'ы не восстанавливаются

**Файл:** `SessionsPage.tsx:775-827`

**Текущее поведение:**
- Checkpoint сохраняется каждые 10 минут
- При visibility change (смена вкладки) тоже сохраняется

**Проблема:**
```
1. Врач ведёт 45-минутную запись
2. Checkpoint'ы сохранены на 10, 20, 30, 40 минуте
3. На 43-й минуте браузер падает
4. При восстановлении: checkpoint'ы НАКОПИЛИСЬ, но НЕ ОБЪЕДИНЯЮТСЯ
5. Врач получает 4 отдельных файла вместо одного
6. 3 минуты записи (40-43) потеряны
```

---

### 1.6. ВЫСОКИЙ: AI-генерация заметок зависает без recovery

**Файл:** `ai.js:448-486`

**Сценарий:**
```
1. Врач нажимает "Сгенерировать заметку"
2. API возвращает success, статус = "generating"
3. Фоновая генерация падает (ошибка OpenAI API)
4. Статус clinical_note ОСТАЁТСЯ "generating" НАВСЕГДА
5. Врач видит бесконечный спиннер
6. Нет способа отменить или перезапустить
```

---

### 1.7. СРЕДНИЙ: Race condition между редактированием и AI

**Файлы:** `ClinicalNotesOutput.tsx:139-159`, `ai.js:502-549`

**Сценарий:**
```
1. Врач редактирует секцию заметки вручную
2. Одновременно нажимает "Перегенерировать всё"
3. Его ручные правки сохраняются в поле "content"
4. AI перезаписывает "ai_content"
5. Race condition: какое поле отображается? Неопределённо.
```

---

## 2. Работа с пациентами

### 2.1. КРИТИЧНО: Удаление пациента без проверки активных сессий

**Файл:** `021_soft_delete_patient.sql:78-81`

```sql
UPDATE patients
SET deleted_at = NOW()
WHERE id = p_patient_id;
-- НЕТ проверки активных сессий!
```

**Сценарий:**
```
1. Админ удаляет пациента (soft delete)
2. У пациента есть сессия в статусе "in_progress"
3. Пациент удалён → сессия становится "сиротой"
4. Врач пытается открыть сессию → "Пациент не найден"
5. Медицинская документация нарушена
```

---

### 2.2. КРИТИЧНО: Race condition при редактировании пациента

**Файл:** `PatientDetailPage.tsx:103-141`

**Сценарий:**
```
1. Врач А открывает карточку пациента (загружает данные)
2. Врач Б открывает ту же карточку
3. Врач Б изменяет телефон и сохраняет
4. Врач А изменяет адрес и сохраняет
5. РЕЗУЛЬТАТ: Телефон врача Б ПЕРЕЗАПИСАН старым значением
6. Нет версионирования, нет предупреждения о конфликте
```

---

### 2.3. ВЫСОКИЙ: Консент не отзывается при удалении пациента

**Файл:** `supabase-patients.ts:533-554`

**Проблема:**
```
1. Пациент даёт согласие на обработку данных (consent)
2. Пациент удаляется из системы
3. Consent ОСТАЁТСЯ активным в БД
4. Нарушение GDPR/HIPAA: удалённый пациент всё ещё "даёт согласие"
```

**Требуется:** При удалении пациента автоматически отзывать все его консенты.

---

### 2.4. ВЫСОКИЙ: Потеря заметок при переназначении врача

**Файл:** `037_patient_assignments.sql:175-180`

```sql
ON CONFLICT (patient_id, doctor_id)
DO UPDATE SET
    notes = EXCLUDED.notes,  -- ПЕРЕЗАПИСЫВАЕТ!
```

**Сценарий:**
```
1. Админ назначает врача пациенту с заметкой "основной врач"
2. Позже переназначает того же врача с типом "консультант" БЕЗ заметки
3. Старые заметки ПЕРЕЗАПИСЫВАЮТСЯ на NULL
4. История назначений потеряна
```

---

### 2.5. СРЕДНИЙ: Кэш пациентов никогда не обновляется

**Файл:** `usePatients.ts:57-72`

```typescript
staleTime: Infinity,  // Данные НИКОГДА не станут "stale"
refetchOnWindowFocus: false,
refetchOnReconnect: false,
```

**Сценарий:**
```
1. Врач открывает список пациентов
2. Админ в другой вкладке добавляет нового пациента
3. Врач НЕ видит нового пациента (кэш stale=Infinity)
4. Врач вынужден перезагрузить страницу
```

---

## 3. Календарь и встречи

### 3.1. КРИТИЧНО: Нет проверки конфликтов времени

**Файлы:** `supabase-sessions.ts:677-870`, `CreateAppointmentDialog.tsx:186-289`

**Сценарий:**
```
1. Админ создаёт встречу врачу на 14:00-15:00
2. Админ создаёт ДРУГУЮ встречу тому же врачу на 14:30-15:30
3. Система НЕ предупреждает о конфликте
4. В календаре два перекрывающихся события
5. Врач физически не может провести обе встречи
```

**Отсутствует:** Проверка `scheduled_at + duration_minutes` против существующих встреч.

---

### 3.2. КРИТИЧНО: Встречи "сиротеют" при удалении пациента

**Файл:** `021_soft_delete_patient.sql:77-81`

**Сценарий:**
```
1. Создана встреча с пациентом на завтра
2. Админ удаляет пациента
3. Встреча ОСТАЁТСЯ в календаре
4. Отображается как "Неизвестный пациент"
5. Врач приходит на несуществующую встречу
```

---

### 3.3. КРИТИЧНО: Неправильная работа часовых поясов

**Файл:** `CreateAppointmentDialog.tsx:244-278`

```typescript
const scheduledDateTime = new Date(selectedDate);
scheduledDateTime.setHours(hours, minutes, 0, 0);
scheduledAt: scheduledDateTime.toISOString()  // Конвертит в UTC!
```

**Сценарий:**
```
1. Врач в Москве (UTC+3) создаёт встречу на 14:00
2. Браузер: new Date() → 14:00 MSK
3. toISOString() → 11:00 UTC (минус 3 часа)
4. В БД сохраняется 11:00 UTC
5. Коллега в Калининграде (UTC+2) видит: 13:00
6. Разное время для разных часовых поясов!
```

---

### 3.4. ВЫСОКИЙ: Опасное удаление повторяющихся встреч

**Файл:** `supabase-sessions.ts:927-949`

**Текущие опции при удалении:**
- Удалить только одну встречу ✓
- Удалить ВСЕ встречи в серии ✓
- Удалить эту и все последующие ✗ (НЕТ!)

**Сценарий:**
```
Курс терапии: 30.01, 06.02, 13.02, 20.02, 27.02

1. Пациент просит отменить с 13.02
2. Врач хочет удалить 13, 20, 27 февраля
3. Нет такой опции!
4. Нажимает "Удалить все" → удаляются ВСЕ включая прошедшие!
5. Потеряна история встреч за 30.01 и 06.02
```

---

### 3.5. ВЫСОКИЙ: Полное отсутствие уведомлений

**Отсутствует:**
- Email/SMS пациенту при создании встречи
- Напоминание врачу за 15 минут
- Уведомление об отмене встречи
- Интеграция с Google Calendar/Outlook

**Влияние:** Пациенты могут не знать о назначенных встречах.

---

## 4. Авторизация и роли

### 4.1. КРИТИЧНО: Администратор может удалить сам себя

**Файл:** `AdministrationPage.tsx:254-278`

**Сценарий:**
```
1. Админ открывает список пользователей
2. Проверка в UI: кнопка "Удалить" скрыта для себя
3. Но API НЕ проверяет это!
4. Через DevTools можно вызвать API напрямую
5. Админ удаляет себя → clinic_id = NULL
6. Админ теряет доступ к своей клинике
```

---

### 4.2. КРИТИЧНО: Клиника остаётся без администратора

**Файл:** `AdministrationPage.tsx:221-252`

**Сценарий 1:**
```
1. В клинике один админ
2. Админ удаляет себя (через обход UI)
3. Клиника БЕЗ администратора
4. Никто не может управлять клиникой
```

**Сценарий 2:**
```
1. В клинике один админ
2. Второй пользователь через AdministrationPage меняет роль админа на "specialist"
3. Клиника БЕЗ администратора
```

**Отсутствует:** Проверка `COUNT(*) FROM profiles WHERE role='admin'` перед удалением/разжалованием.

---

### 4.3. ВЫСОКИЙ: Неправильный MFA factorId

**Файл:** `AuthContext.tsx:737-775`

```typescript
const verifyMFA = useCallback(async (code: string) => {
  const { error } = await supabase.auth.mfa.verify({
    factorId: 'totp',  // HARDCODED! Должен быть UUID из enrollment
    code,
  });
```

**Проблема:** При включении MFA возвращается реальный `factorId` (UUID), но верификация использует hardcoded 'totp'. Верификация может отказать даже при правильном коде.

---

### 4.4. ВЫСОКИЙ: Session timeout без предупреждения

**Файл:** `AuthContext.tsx:47-50, 283-301`

```typescript
const SESSION_WARNING_TIME = 2 * 60 * 1000; // Определено, но НЕ используется!

// Проверка просто делает logout:
if (timeSinceActivity >= SESSION_TIMEOUT) {
  signOut();  // Без предупреждения!
}
```

**Сценарий:**
```
1. Врач заполняет длинную клиническую записку
2. 15 минут неактивности (думает над формулировкой)
3. Автоматический logout БЕЗ предупреждения
4. Вся несохранённая работа ПОТЕРЯНА
```

---

### 4.5. СРЕДНИЙ: Приглашение существующего email из другой клиники

**Файл:** `AdministrationPage.tsx:167-178`

```typescript
// Проверка ТОЛЬКО в текущей клинике:
.eq('clinic_id', profile.clinic_id)
```

**Сценарий:**
```
1. Врач зарегистрирован в Клинике А
2. Админ Клиники Б приглашает тот же email
3. Приглашение создаётся (email не найден в Клинике Б)
4. При попытке регистрации → конфликт user_id
```

---

### 4.6. СРЕДНИЙ: Нет аудита смены ролей

**Файл:** `AdministrationPage.tsx:229-237`

**Проблема:**
- Смена роли (admin ↔ specialist) не логируется
- Пользователь не уведомляется о смене роли
- Нет истории для compliance/HIPAA

---

## 5. Сводная таблица

| # | Проблема | Раздел | Файл | Критичность |
|---|----------|--------|------|-------------|
| 1 | Потеря записи при частичном сохранении | Запись | ScribePage.tsx:299-354 | КРИТИЧНО |
| 2 | Deadlock в stopRecording | Запись | useAudioRecorder.ts:215-231 | КРИТИЧНО |
| 3 | Транскрипция зависает навсегда | Запись | useTranscriptionRecovery.ts:123-134 | КРИТИЧНО |
| 4 | Удаление пациента без проверки сессий | Пациенты | 021_soft_delete_patient.sql:78-81 | КРИТИЧНО |
| 5 | Race condition при редактировании | Пациенты | PatientDetailPage.tsx:103-141 | КРИТИЧНО |
| 6 | Нет проверки конфликтов времени | Календарь | supabase-sessions.ts:677-870 | КРИТИЧНО |
| 7 | Встречи сиротеют при удалении пациента | Календарь | 021_soft_delete_patient.sql:77-81 | КРИТИЧНО |
| 8 | Неправильная работа часовых поясов | Календарь | CreateAppointmentDialog.tsx:244-278 | КРИТИЧНО |
| 9 | Администратор удаляет себя | Авторизация | AdministrationPage.tsx:254-278 | КРИТИЧНО |
| 10 | Клиника без администратора | Авторизация | AdministrationPage.tsx:221-252 | КРИТИЧНО |
| 11 | Дублирование транскрипции | Запись | RecordingCard.tsx:129-149 | ВЫСОКИЙ |
| 12 | Checkpoint'ы не восстанавливаются | Запись | SessionsPage.tsx:775-827 | ВЫСОКИЙ |
| 13 | AI-генерация зависает | Запись | ai.js:448-486 | ВЫСОКИЙ |
| 14 | Консент не отзывается | Пациенты | supabase-patients.ts:533-554 | ВЫСОКИЙ |
| 15 | Потеря заметок при переназначении | Пациенты | 037_patient_assignments.sql:175-180 | ВЫСОКИЙ |
| 16 | Опасное удаление повторяющихся встреч | Календарь | supabase-sessions.ts:927-949 | ВЫСОКИЙ |
| 17 | Отсутствие уведомлений | Календарь | - | ВЫСОКИЙ |
| 18 | Неправильный MFA factorId | Авторизация | AuthContext.tsx:737-775 | ВЫСОКИЙ |
| 19 | Session timeout без предупреждения | Авторизация | AuthContext.tsx:283-301 | ВЫСОКИЙ |
| 20 | Race condition AI + редактирование | Запись | ClinicalNotesOutput.tsx:139-159 | СРЕДНИЙ |
| 21 | Кэш пациентов stale=Infinity | Пациенты | usePatients.ts:57-72 | СРЕДНИЙ |
| 22 | Приглашение существующего email | Авторизация | AdministrationPage.tsx:167-178 | СРЕДНИЙ |
| 23 | Нет аудита смены ролей | Авторизация | AdministrationPage.tsx:229-237 | СРЕДНИЙ |

---

## Приоритетный план исправлений

### Немедленно (блокирующие проблемы):
1. Добавить timeout в `stopRecording()` — предотвращает зависание UI
2. Проверка единственного админа при удалении/разжаловании
3. Проверка активных сессий при удалении пациента
4. Проверка конфликтов времени при создании встреч

### Срочно (потеря данных):
5. Исправить логику сохранения при fail IndexedDB + success Supabase
6. Добавить механизм отмены/перезапуска транскрипции
7. Добавить версионирование при редактировании пациента
8. Исправить работу часовых поясов в календаре

### Важно (compliance/UX):
9. Отзыв консентов при удалении пациента
10. Предупреждение за 2 минуты до session timeout
11. Исправить MFA factorId
12. Добавить опцию "удалить эту и последующие" для повторяющихся встреч

### Желательно (улучшения):
13. Система уведомлений о встречах
14. Аудит изменений ролей
15. Объединение checkpoint'ов при восстановлении
16. Обновление кэша пациентов

---

*Отчёт сгенерирован: 2026-01-18*
*Версия: 1.0 (функциональный анализ)*
*Всего выявлено: 23 проблемы (10 критических, 9 высоких, 4 средних)*
