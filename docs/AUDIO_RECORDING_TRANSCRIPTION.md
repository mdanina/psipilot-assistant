# Функционал записи аудио и транскрипции

## Обзор

Реализован полный функционал записи аудио и автоматической транскрипции для медицинской документации. Система позволяет:

- Записывать аудио через браузер (MediaRecorder API)
- Сохранять записи в Supabase Storage
- Автоматически транскрибировать через AssemblyAI API
- Создавать сессии без привязки к пациенту (привязка происходит позже)
- Отслеживать статус транскрипции в реальном времени

## Архитектура

### Компоненты системы

1. **Фронтенд (React)**
   - `useAudioRecorder` - хук для записи аудио
   - `RecordingCard` - UI компонент для управления записью
   - `ScribePage` - страница для начала записи
   - `SessionsPage` - страница для управления сессиями и привязки к пациентам

2. **Backend сервис (Node.js/Express)**
   - `backend/transcription-service/` - отдельный сервис для транскрипции
   - Интеграция с AssemblyAI API
   - Аутентификация через Supabase JWT

3. **База данных (Supabase/PostgreSQL)**
   - Таблица `sessions` - сессии записи (patient_id может быть NULL)
   - Таблица `recordings` - записи аудио с транскрипциями
   - Storage bucket `recordings` - хранение аудио файлов

## Миграция базы данных

### 013_make_sessions_patient_nullable.sql

Эта миграция позволяет создавать сессии без привязки к пациенту, что необходимо для рабочего процесса:

1. Пользователь начинает запись на странице Скрайбер
2. Создается сессия без patient_id
3. Запись сохраняется и транскрибируется
4. Позже на странице Сессий пользователь привязывает сессию к пациенту

#### Изменения:

- `sessions.patient_id` изменен на `NULL` (было `NOT NULL`)
- Обновлены RLS политики для поддержки сессий без пациента:
  - Сессии без пациента видны всем пользователям клиники (без проверки согласия)
  - Сессии с пациентом требуют проверки согласия на обработку данных
- Обновлены политики для `recordings` и `clinical_notes` для поддержки NULL patient_id

#### Безопасность:

- Сессии без пациента не содержат PHI данных, поэтому не требуют согласия
- При привязке к пациенту применяются все политики безопасности и проверки согласия
- Аудит всех операций сохраняется

## Рабочий процесс

### 1. Начало записи (ScribePage)

1. Пользователь нажимает "Начать запись"
2. Запрашивается доступ к микрофону браузера
3. Создается новая сессия в БД (без patient_id, но с clinic_id и user_id)
4. Сохраняется `started_at` - время начала записи
5. Начинается запись через MediaRecorder API

### 2. Запись аудио

- Поддерживаются форматы: audio/webm, audio/mp4, audio/ogg
- Автоматический выбор лучшего поддерживаемого формата
- Возможность паузы/возобновления записи
- Визуализация волновой формы в реальном времени
- Отображение времени записи

### 3. Сохранение записи

1. Пользователь останавливает запись
2. Аудио сохраняется в Blob
3. Создается запись в таблице `recordings`
4. Аудио файл загружается в Supabase Storage (bucket `recordings`)
5. Обновляется запись с путем к файлу и размером

### 4. Транскрипция

1. После загрузки файла автоматически запускается транскрипция
2. Фронтенд вызывает backend API `/api/transcribe`
3. Backend сервис:
   - Получает signed URL для аудио файла из Supabase Storage
   - Отправляет файл в AssemblyAI API
   - Обновляет статус транскрипции в БД
4. Фронтенд опрашивает статус транскрипции (polling)
5. При завершении транскрипция сохраняется в БД

### 5. Привязка к пациенту (SessionsPage)

1. Пользователь переходит на страницу Сессий
2. Видит все сессии, включая без пациента (с индикатором "Не привязано")
3. Выбирает сессию и нажимает "Привязать к пациенту"
4. Выбирает пациента из списка
5. Сессия обновляется с patient_id
6. Теперь сессия появляется в истории пациента

## API Endpoints

### Backend Transcription Service

#### POST /api/transcribe

Запускает транскрипцию для записи.

**Headers:**
```
Authorization: Bearer <supabase-jwt-token>
```

**Body:**
```json
{
  "recordingId": "uuid-of-recording"
}
```

**Response:**
```json
{
  "success": true,
  "recordingId": "uuid",
  "transcriptId": "assemblyai-transcript-id",
  "status": "processing"
}
```

#### GET /api/transcribe/:recordingId/status

Получает статус транскрипции.

**Headers:**
```
Authorization: Bearer <supabase-jwt-token>
```

**Response:**
```json
{
  "status": "completed",
  "transcriptionText": "Транскрибированный текст...",
  "error": null
}
```

## Безопасность

### Аутентификация

- Все API endpoints требуют Supabase JWT токен
- Backend сервис проверяет токен перед обработкой запросов
- Проверяется доступ пользователя к записи (только свои записи)

### Хранение данных

- Аудио файлы хранятся в Supabase Storage с RLS политиками
- Транскрипции могут быть зашифрованы (поле `transcription_text_encrypted`)
- API ключ AssemblyAI хранится только на backend (не в клиенте)

### Согласие пациента

- Перед началом записи рекомендуется проверить согласие на запись
- Сессии без пациента не требуют согласия (нет PHI данных)
- При привязке к пациенту применяются все проверки согласия

## Конфигурация

### Переменные окружения (Frontend)

```env
VITE_SUPABASE_URL=http://localhost:8000
VITE_SUPABASE_ANON_KEY=your-anon-key
VITE_TRANSCRIPTION_API_URL=http://localhost:3001
```

### Переменные окружения (Backend)

```env
PORT=3001
ASSEMBLYAI_API_KEY=your-assemblyai-api-key
SUPABASE_URL=http://localhost:8000
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
```

## Структура данных

### Таблица sessions

```sql
CREATE TABLE sessions (
    id UUID PRIMARY KEY,
    patient_id UUID NULL,  -- Может быть NULL!
    user_id UUID NOT NULL,
    clinic_id UUID NOT NULL,
    title VARCHAR(255),
    status VARCHAR(50),
    started_at TIMESTAMPTZ,
    -- ...
);
```

### Таблица recordings

```sql
CREATE TABLE recordings (
    id UUID PRIMARY KEY,
    session_id UUID NOT NULL,
    user_id UUID NOT NULL,
    file_path TEXT NOT NULL,
    file_name VARCHAR(255),
    file_size_bytes BIGINT,
    mime_type VARCHAR(100),
    duration_seconds INTEGER,
    transcription_status VARCHAR(50),  -- pending, processing, completed, failed
    transcription_text TEXT,
    transcription_error TEXT,
    -- ...
);
```

## Обработка ошибок

### Ошибки доступа к микрофону

- Показывается понятное сообщение пользователю
- Различные типы ошибок обрабатываются отдельно:
  - Permission denied - доступ запрещен
  - Device not found - микрофон не найден

### Ошибки транскрипции

- Статус записи обновляется на `failed`
- Ошибка сохраняется в `transcription_error`
- Пользователь может повторить транскрипцию позже

### Ошибки загрузки

- Показывается toast уведомление
- Запись сохраняется в БД даже при ошибке загрузки файла
- Можно повторить загрузку позже

## Мониторинг и отладка

### Логирование

- Все операции логируются в консоль браузера (frontend)
- Backend сервис логирует все запросы и ошибки
- Используйте DevTools для отладки

### Проверка статуса

- Статус транскрипции можно проверить через API
- В UI отображается текущий статус с индикаторами
- Polling автоматически обновляет статус

## Известные ограничения

1. **Размер файлов**: Ограничения Supabase Storage (по умолчанию 50MB на файл)
2. **Длительность транскрипции**: Зависит от длины аудио и загрузки AssemblyAI
3. **Форматы аудио**: Зависит от поддержки браузером MediaRecorder API
4. **Одновременные записи**: Одна запись на сессию (можно расширить)

## Будущие улучшения

- [ ] Поддержка нескольких записей на сессию
- [ ] Асинхронная транскрипция через webhooks
- [ ] Поддержка видео записей
- [ ] Автоматическое создание клинических заметок из транскрипции
- [ ] Интеграция с AI для структурирования заметок
- [ ] Экспорт транскрипций в различные форматы

## Troubleshooting

### Запись не начинается

1. Проверьте разрешения браузера на доступ к микрофону
2. Убедитесь, что микрофон подключен и работает
3. Проверьте консоль браузера на ошибки

### Транскрипция не запускается

1. Проверьте, что backend сервис запущен
2. Убедитесь, что `VITE_TRANSCRIPTION_API_URL` настроен правильно
3. Проверьте логи backend сервиса
4. Убедитесь, что AssemblyAI API ключ валиден

### Файл не загружается

1. Проверьте, что bucket `recordings` существует в Supabase Storage
2. Убедитесь, что RLS политики настроены правильно
3. Проверьте размер файла (не превышает лимит)

## Связанные файлы

- `src/hooks/useAudioRecorder.ts` - хук для записи аудио
- `src/lib/supabase-recordings.ts` - сервис для работы с записями
- `src/lib/supabase-sessions.ts` - сервис для работы с сессиями
- `src/components/scribe/RecordingCard.tsx` - UI компонент записи
- `src/pages/ScribePage.tsx` - страница начала записи
- `src/pages/SessionsPage.tsx` - страница управления сессиями
- `backend/transcription-service/` - backend сервис транскрипции
- `supabase/migrations/013_make_sessions_patient_nullable.sql` - миграция БД

