# Документация: Заметки и файлы в сессиях

## Обзор

В разделе сессий реализован функционал добавления заметок специалиста, которые могут быть созданы двумя способами:
1. **Вручную** - ввод текста через интерфейс
2. **Из файла** - загрузка и автоматическое извлечение текста из поддерживаемых форматов файлов

Заметки автоматически объединяются с транскриптами записей и отображаются в общем тексте сессии с префиксом "--- Комментарии специалиста ---".

## Архитектура

### База данных

#### Таблица `session_notes`

Таблица хранит заметки специалиста, привязанные к сессиям:

```sql
CREATE TABLE session_notes (
    id UUID PRIMARY KEY,
    session_id UUID NOT NULL REFERENCES sessions(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES profiles(id),
    content TEXT NOT NULL,
    source TEXT NOT NULL DEFAULT 'manual' CHECK (source IN ('manual', 'file')),
    original_filename TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

**Поля:**
- `id` - уникальный идентификатор заметки
- `session_id` - ссылка на сессию
- `user_id` - пользователь, создавший заметку
- `content` - текстовое содержимое заметки
- `source` - источник создания: `'manual'` (вручную) или `'file'` (из файла)
- `original_filename` - оригинальное имя файла (если заметка создана из файла)
- `created_at` / `updated_at` - временные метки

**Индексы:**
- `idx_session_notes_session_id` - для быстрого поиска заметок по сессии
- `idx_session_notes_user_id` - для фильтрации по пользователю
- `idx_session_notes_created_at` - для сортировки по дате

**Row Level Security (RLS):**
- Пользователи могут просматривать заметки для сессий в своей клинике
- Пользователи могут создавать заметки для сессий в своей клинике
- Пользователи могут обновлять и удалять только свои собственные заметки

### Компоненты

#### 1. `SessionsPage.tsx`

Основная страница сессий, которая:
- Отображает список сессий
- Показывает транскрипты записей
- Отображает список заметок специалиста
- Управляет состоянием заметок
- Объединяет транскрипты с заметками

**Ключевые функции:**
- `loadSessionNotes(sessionId)` - загрузка заметок для сессии
- `handleCreateNote(content, source, filename?)` - создание новой заметки
- `handleDeleteNote(noteId)` - удаление заметки
- `getCombinedTranscriptWithNotes()` - объединение транскрипта с заметками

**Состояние:**
```typescript
const [sessionNotes, setSessionNotes] = useState<SessionNote[]>([]);
const [notesDialogOpen, setNotesDialogOpen] = useState(false);
```

#### 2. `SessionNotesDialog.tsx`

Диалоговое окно для добавления заметок с двумя вкладками:

**Вкладка "Ввод текста":**
- Текстовое поле для ручного ввода заметки
- Простая валидация на непустой текст

**Вкладка "Загрузить файл":**
- Drag & Drop зона для перетаскивания файлов
- Кнопка выбора файла
- Поддержка форматов: TXT, MD, JSON, DOC, DOCX, PDF
- Автоматическое извлечение текста из файла
- Предпросмотр извлеченного текста (первые 1000 символов)

**Процесс работы:**
1. Пользователь выбирает файл или вводит текст
2. Если файл - происходит парсинг через `parseFile()`
3. Показывается предпросмотр содержимого
4. При сохранении вызывается `onSave()` с параметрами:
   - `content` - текст заметки
   - `source` - `'manual'` или `'file'`
   - `filename` - имя файла (опционально)

#### 3. `supabase-session-notes.ts`

Библиотека для работы с заметками в Supabase:

**Функции:**

```typescript
// Получить все заметки для сессии
getSessionNotes(sessionId: string): Promise<SessionNote[]>

// Создать новую заметку
createSessionNote(params: {
  sessionId: string;
  userId: string;
  content: string;
  source: 'manual' | 'file';
  originalFilename?: string | null;
}): Promise<SessionNote>

// Удалить заметку
deleteSessionNote(noteId: string): Promise<void>

// Объединить транскрипт с заметками
getCombinedTranscriptWithNotes(
  transcriptText: string,
  notes: SessionNote[]
): string
```

#### 4. `file-parser.ts`

Утилита для парсинга различных форматов файлов:

**Поддерживаемые форматы:**
- `.txt`, `.md` - простой текстовый парсинг
- `.json` - рекурсивное извлечение всех строковых значений
- `.doc`, `.docx` - парсинг через библиотеку `mammoth`
- `.pdf` - парсинг через `pdf.js`

**Функции:**

```typescript
// Проверить, поддерживается ли формат
isSupportedFile(filename: string): boolean

// Парсить файл и извлечь текст
parseFile(file: File): Promise<string>

// Получить описание поддерживаемых форматов
getFormatDescription(): string
```

**Зависимости:**
- `mammoth` - для парсинга Word документов
- `pdfjs-dist` - для парсинга PDF документов

## Пользовательский сценарий

### Добавление заметки вручную

1. Пользователь открывает страницу сессий
2. Выбирает активную сессию
3. Нажимает кнопку с иконкой `FileText` в панели управления записью
4. Открывается диалог `SessionNotesDialog`
5. На вкладке "Ввод текста" вводит текст заметки
6. Нажимает "Сохранить"
7. Заметка сохраняется в базу данных
8. Список заметок обновляется
9. Заметка отображается в разделе "Заметки специалиста"
10. Текст заметки добавляется к объединенному транскрипту

### Добавление заметки из файла

1. Пользователь открывает диалог добавления заметки
2. Переходит на вкладку "Загрузить файл"
3. Выбирает файл одним из способов:
   - Перетаскивает файл в зону Drag & Drop
   - Нажимает "Выберите файл" и выбирает из файловой системы
4. Система проверяет формат файла
5. Если формат поддерживается - начинается парсинг
6. Показывается индикатор загрузки "Извлечение текста..."
7. После парсинга отображается предпросмотр извлеченного текста
8. Пользователь может удалить файл и выбрать другой
9. При нажатии "Сохранить":
   - Текст из файла сохраняется как заметка
   - Сохраняется оригинальное имя файла
   - `source` устанавливается в `'file'`
10. Заметка появляется в списке с иконкой файла и именем файла

### Просмотр заметок

Заметки отображаются в левой панели страницы сессий:

- **Заголовок:** "Заметки специалиста"
- **Для каждой заметки:**
  - Иконка файла (если из файла)
  - Имя файла или "Заметка" (если вручную)
  - Дата и время создания
  - Кнопка удаления
  - Превью содержимого (первые 300 символов)

### Объединение с транскриптом

Заметки автоматически добавляются к транскрипту записей:

```
[Транскрипт записи 1]

[Транскрипт записи 2]

--- Комментарии специалиста ---

[Содержимое заметки 1]

[Содержимое заметки 2]
```

Если транскрипта нет, заметки отображаются с заголовком:
```
--- Комментарии специалиста ---

[Содержимое заметок]
```

## Технические детали

### Парсинг файлов

#### Текстовые файлы (.txt, .md)
```typescript
async function parseTextFile(file: File): Promise<string> {
  return await file.text();
}
```

#### JSON файлы (.json)
Рекурсивно извлекаются все строковые значения из структуры JSON:
```typescript
function extractStrings(obj: unknown, depth = 0): void {
  if (typeof obj === 'string' && obj.trim().length > 0) {
    extractedTexts.push(obj.trim());
  } else if (Array.isArray(obj)) {
    obj.forEach(item => extractStrings(item, depth + 1));
  } else if (obj && typeof obj === 'object') {
    Object.values(obj).forEach(value => extractStrings(value, depth + 1));
  }
}
```

#### Word документы (.doc, .docx)
Используется библиотека `mammoth` для извлечения текста:
```typescript
const mammoth = await import('mammoth');
const arrayBuffer = await file.arrayBuffer();
const result = await mammoth.extractRawText({ arrayBuffer });
return result.value;
```

#### PDF документы (.pdf)
Используется `pdf.js` для извлечения текста со всех страниц:
```typescript
const pdfjsLib = await import('pdfjs-dist');
const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
// Извлечение текста со всех страниц
```

### Безопасность

1. **Row Level Security (RLS):**
   - Пользователи видят только заметки для сессий в своей клинике
   - Пользователи могут создавать заметки только для сессий в своей клинике
   - Пользователи могут удалять только свои собственные заметки

2. **Валидация файлов:**
   - Проверка расширения файла перед парсингом
   - Обработка ошибок парсинга с понятными сообщениями
   - Ограничение глубины рекурсии при парсинге JSON (максимум 10 уровней)

3. **Обработка ошибок:**
   - Все ошибки парсинга отображаются пользователю через toast-уведомления
   - Ошибки базы данных логируются в консоль
   - Пользовательские сообщения об ошибках на русском языке

### Производительность

1. **Ленивая загрузка библиотек:**
   - `mammoth` и `pdfjs-dist` загружаются динамически только при необходимости
   - Уменьшает размер начального бандла

2. **Индексы базы данных:**
   - Индексы на `session_id`, `user_id`, `created_at` для быстрых запросов

3. **Ограничение предпросмотра:**
   - Показываются первые 1000 символов извлеченного текста
   - Показываются первые 300 символов в списке заметок

## Миграция базы данных

Миграция находится в файле `supabase/migrations/022_session_notes.sql` и включает:
- Создание таблицы `session_notes`
- Создание индексов
- Настройку Row Level Security
- Создание триггера для автоматического обновления `updated_at`
- Комментарии к таблице и полям

## Примеры использования

### Создание заметки вручную

```typescript
await handleCreateNote(
  "Пациент сообщил о улучшении настроения после последней сессии",
  'manual'
);
```

### Создание заметки из файла

```typescript
const file = event.target.files[0];
const content = await parseFile(file);
await handleCreateNote(
  content,
  'file',
  file.name
);
```

### Получение объединенного транскрипта

```typescript
const rawTranscript = recordings
  .filter(r => r.transcription_status === 'completed')
  .map(r => r.transcription_text)
  .join('\n\n');

const combinedTranscript = getCombinedTranscriptWithNotes(
  rawTranscript,
  sessionNotes
);
```

## Будущие улучшения

Возможные направления развития:

1. **Редактирование заметок:**
   - Добавить возможность редактирования существующих заметок
   - История изменений

2. **Расширенная поддержка файлов:**
   - Поддержка изображений с OCR
   - Поддержка Excel файлов
   - Поддержка RTF файлов

3. **Категоризация заметок:**
   - Теги для заметок
   - Категории (наблюдения, рекомендации, планы)

4. **Поиск и фильтрация:**
   - Поиск по содержимому заметок
   - Фильтрация по дате, источнику, автору

5. **Экспорт:**
   - Экспорт заметок в различные форматы
   - Печать заметок

## Связанные файлы

- `src/pages/SessionsPage.tsx` - основная страница сессий
- `src/components/sessions/SessionNotesDialog.tsx` - диалог добавления заметок
- `src/lib/supabase-session-notes.ts` - API для работы с заметками
- `src/lib/file-parser.ts` - парсер файлов
- `supabase/migrations/022_session_notes.sql` - миграция базы данных

