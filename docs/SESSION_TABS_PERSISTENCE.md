# Персистентность открытых вкладок сессий

**Дата реализации:** 2025-01-XX  
**Миграция:** `029_user_session_tabs.sql`  
**Связанные файлы:** `src/pages/SessionsPage.tsx`

---

## Проблема

При закрытии вкладок сессий в разделе "Сессии" они исчезали из интерфейса, но после обновления страницы снова появлялись. Это происходило потому, что:

1. Состояние открытых вкладок хранилось только в памяти React (`useState`)
2. При обновлении страницы состояние сбрасывалось
3. При первой загрузке автоматически открывались все сессии

Также при переходе из карточки пациента → активности → сессия, сессия не открывалась автоматически.

---

## Решение

Реализовано хранение состояния открытых вкладок в базе данных PostgreSQL через отдельную таблицу `user_session_tabs`.

### Архитектура

#### База данных

**Таблица:** `user_session_tabs`
- `id` (UUID) — первичный ключ
- `user_id` (UUID) — ссылка на пользователя (`profiles.id`)
- `session_id` (UUID) — ссылка на сессию (`sessions.id`)
- `opened_at` (TIMESTAMPTZ) — время открытия вкладки
- `created_at` (TIMESTAMPTZ) — время создания записи
- Уникальное ограничение: `(user_id, session_id)` — один пользователь может иметь только одну запись на сессию

**RLS политики:**
- Пользователи могут видеть только свои открытые вкладки
- Пользователи могут добавлять только свои вкладки
- Пользователи могут удалять только свои вкладки

**Миграция данных:**
- При первом применении миграции все существующие сессии автоматически добавляются в таблицу для каждого пользователя
- Это обеспечивает обратную совместимость для существующих пользователей

#### Frontend

**Компонент:** `SessionsPage.tsx`

**Ключевые функции:**

1. **`loadOpenTabs()`** — загружает открытые вкладки из БД при монтировании компонента
2. **`saveOpenTabs()`** — сохраняет изменения в БД (debounced на 500ms для оптимизации)
3. **Обработка навигации** — при переходе с `sessionId`:
   - Сначала сохраняет сессию в БД
   - Затем загружает все вкладки из БД
   - Устанавливает активную сессию

**Поддержка навигации:**
- Через `location.state.sessionId` (из ScribePage)
- Через URL параметры `?sessionId=...` (из карточки пациента)

**Пустое состояние:**
- Когда все вкладки закрыты, показывается пустое состояние с кнопкой "Создать новую сессию"
- Область вкладок скрывается, чтобы избежать дублирования UI

---

## Преимущества решения

1. ✅ **Персистентность** — состояние сохраняется между сессиями и устройствами
2. ✅ **Надежность** — данные хранятся в БД, а не только в памяти браузера
3. ✅ **Масштабируемость** — можно добавить аналитику, историю открытий и т.д.
4. ✅ **Безопасность** — RLS политики обеспечивают изоляцию данных пользователей
5. ✅ **Обратная совместимость** — миграция данных для существующих пользователей

---

## Использование

### Для пользователей

- При закрытии вкладки она удаляется из БД и не вернется после обновления страницы
- При открытии новой вкладки она сохраняется в БД
- При переходе из карточки пациента сессия автоматически открывается
- Состояние синхронизируется между вкладками браузера и устройствами

### Для разработчиков

**Добавление новой вкладки:**
```typescript
setOpenTabs(prev => {
  const newTabs = new Set(prev);
  newTabs.add(sessionId);
  return newTabs;
});
// Автоматически сохранится в БД через useEffect
```

**Закрытие вкладки:**
```typescript
setOpenTabs(prev => {
  const newTabs = new Set(prev);
  newTabs.delete(sessionId);
  return newTabs;
});
// Автоматически удалится из БД через useEffect
```

**Навигация с открытием сессии:**
```typescript
// Из компонента
navigate('/sessions', { state: { sessionId: 'xxx' } });
// Или через URL
navigate('/sessions?sessionId=xxx');
```

---

## Технические детали

### Порядок выполнения при навигации

1. Пользователь переходит на `/sessions?sessionId=xxx`
2. `useEffect` обнаруживает `sessionId` в URL параметрах
3. Проверяется, что сессия существует в загруженных сессиях
4. Сессия сохраняется в `user_session_tabs` (если еще не существует)
5. Все вкладки загружаются из БД заново
6. `activeSession` устанавливается на переданную сессию
7. URL параметры очищаются

### Оптимизации

- **Debounce сохранения** — изменения вкладок сохраняются в БД с задержкой 500ms, чтобы избежать избыточных запросов
- **Проверка существования** — перед добавлением проверяется, не существует ли уже запись (UNIQUE constraint)
- **Защита от гонок** — `processingNavigationRef` предотвращает конфликты между разными `useEffect`

---

## Миграция

**Файл:** `supabase/migrations/029_user_session_tabs.sql`

**Идемпотентность:**
- Используется `CREATE TABLE IF NOT EXISTS`
- Индексы создаются с проверкой существования
- Политики RLS создаются с проверкой существования
- Миграция данных использует `ON CONFLICT DO NOTHING`

**Безопасность:**
- Миграция данных выполняется до включения RLS, чтобы избежать проблем с правами доступа

---

## Возможные улучшения в будущем

1. **История открытий** — отслеживание, когда и как часто открываются сессии
2. **Порядок вкладок** — сохранение порядка открытых вкладок
3. **Группировка** — возможность группировать вкладки по пациентам или датам
4. **Синхронизация в реальном времени** — обновление вкладок при изменениях на других устройствах

