# –ö–æ–¥-—Ä–µ–≤—å—é: –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å

**–î–∞—Ç–∞:** 2024  
**–û–±–ª–∞—Å—Ç—å:** –ú–∏–≥—Ä–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (Supabase/PostgreSQL)  
**–§–æ–∫—É—Å:** –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, race conditions, –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

---

## üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. Race Condition –≤ `create_clinic_for_onboarding()` (009_fix_clinic_creation_policy.sql)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–µ–∂–¥—É –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞–ª–∏—á–∏—è –∫–ª–∏–Ω–∏–∫–∏ –∏ –µ—ë —Å–æ–∑–¥–∞–Ω–∏–µ–º –≤–æ–∑–º–æ–∂–Ω–∞ –≥–æ–Ω–∫–∞ (race condition).

```sql
-- –°—Ç—Ä–æ–∫–∏ 34-40: –ü—Ä–æ–≤–µ—Ä–∫–∞
SELECT clinic_id INTO v_existing_clinic_id
FROM profiles
WHERE id = v_user_id;

IF v_existing_clinic_id IS NOT NULL THEN
    RAISE EXCEPTION 'User already has a clinic assigned';
END IF;

-- –°—Ç—Ä–æ–∫–∏ 43-45: –°–æ–∑–¥–∞–Ω–∏–µ (–∑–¥–µ—Å—å –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –≥–æ–Ω–∫–∞!)
INSERT INTO clinics (name, address, phone, email)
VALUES (clinic_name, clinic_address, clinic_phone, clinic_email)
RETURNING id INTO v_clinic_id;
```

**–†–∏—Å–∫:** –î–≤–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞ –º–æ–≥—É—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–æ–π—Ç–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –∏ —Å–æ–∑–¥–∞—Ç—å –¥–≤–µ –∫–ª–∏–Ω–∏–∫–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**–†–µ—à–µ–Ω–∏–µ:**
```sql
-- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SELECT FOR UPDATE –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å—Ç—Ä–æ–∫–∏
SELECT clinic_id INTO v_existing_clinic_id
FROM profiles
WHERE id = v_user_id
FOR UPDATE;  -- –ë–ª–æ–∫–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É –¥–æ –∫–æ–Ω—Ü–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

-- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ + –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–∫–∏
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –î–æ–±–∞–≤–∏—Ç—å `FOR UPDATE` –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å advisory lock.

---

### 2. –ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è RLS –ø–æ–ª–∏—Ç–∏–∫–∞ –≤ `009_fix_clinic_creation_policy.sql`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª–∏—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –≤–ª–æ–∂–µ–Ω–Ω—ã–µ `EXISTS` –±–µ–∑ –∏–Ω–¥–µ–∫—Å–æ–≤, —á—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–æ.

```sql
-- –°—Ç—Ä–æ–∫–∏ 88-97
WITH CHECK (
    auth.uid() IS NOT NULL
    AND (
        NOT EXISTS (
            SELECT 1 FROM profiles WHERE id = auth.uid()
        )
        OR
        EXISTS (
            SELECT 1 FROM profiles
            WHERE id = auth.uid()
            AND clinic_id IS NULL
        )
    )
);
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –î–≤–∞ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö `EXISTS` –∑–∞–ø—Ä–æ—Å–∞ –≤–º–µ—Å—Ç–æ –æ–¥–Ω–æ–≥–æ
- `profiles.id` - —ç—Ç–æ PRIMARY KEY, –Ω–æ –∑–∞–ø—Ä–æ—Å –º–æ–∂–Ω–æ —É–ø—Ä–æ—Å—Ç–∏—Ç—å

**–†–µ—à–µ–Ω–∏–µ:**
```sql
WITH CHECK (
    auth.uid() IS NOT NULL
    AND (
        -- –û–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ –¥–≤—É—Ö
        SELECT clinic_id IS NULL
        FROM profiles
        WHERE id = auth.uid()
    )
);
```

---

### 3. –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã `get_user_clinic_id()` –≤ RLS –ø–æ–ª–∏—Ç–∏–∫–∞—Ö

**–ü—Ä–æ–±–ª–µ–º–∞:** –§—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –æ–¥–Ω–æ–π –ø–æ–ª–∏—Ç–∏–∫–µ, —á—Ç–æ –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ.

**–ü—Ä–∏–º–µ—Ä –∏–∑ 002_row_level_security.sql:**
```sql
-- –°—Ç—Ä–æ–∫–∞ 65: –í—ã–∑–æ–≤ 1
USING (id = get_user_clinic_id());

-- –°—Ç—Ä–æ–∫–∞ 70: –í—ã–∑–æ–≤ 2
USING (id = get_user_clinic_id() AND is_user_admin());
```

**–ü—Ä–æ–±–ª–µ–º–∞:** PostgreSQL –º–æ–∂–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±–ª–∞–≥–æ–¥–∞—Ä—è `STABLE`, –Ω–æ –ª—É—á—à–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å.

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–¥–∑–∞–ø—Ä–æ—Å –∏–ª–∏ CTE –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –æ–¥–∏–Ω —Ä–∞–∑:
```sql
WITH user_clinic AS (
    SELECT get_user_clinic_id() AS clinic_id
)
USING (id = (SELECT clinic_id FROM user_clinic));
```

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –í PostgreSQL 12+ —Å `STABLE` —Ñ—É–Ω–∫—Ü–∏—è–º–∏ —ç—Ç–æ –º–µ–Ω–µ–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –Ω–æ –≤—Å—ë —Ä–∞–≤–Ω–æ —Å—Ç–æ–∏—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å.

---

## üü° –ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### 4. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –Ω–∞ `profiles.role`

**–ü—Ä–æ–±–ª–µ–º–∞:** –§—É–Ω–∫—Ü–∏—è `is_user_admin()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `role = 'admin'`, –Ω–æ –Ω–µ—Ç –∏–Ω–¥–µ–∫—Å–∞ –Ω–∞ `role`.

**–§–∞–π–ª:** 002_row_level_security.sql, —Å—Ç—Ä–æ–∫–∞ 26

**–†–µ—à–µ–Ω–∏–µ:**
```sql
CREATE INDEX IF NOT EXISTS idx_profiles_role ON profiles(role) WHERE role = 'admin';
-- –ß–∞—Å—Ç–∏—á–Ω—ã–π –∏–Ω–¥–µ–∫—Å, —Ç–∞–∫ –∫–∞–∫ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ –∞–¥–º–∏–Ω—ã
```

---

### 5. –ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ EXISTS –ø–æ–¥–∑–∞–ø—Ä–æ—Å—ã –≤ RLS –ø–æ–ª–∏—Ç–∏–∫–∞—Ö

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–Ω–æ–≥–∏–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `EXISTS` —Å JOIN, —á—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–æ –±–µ–∑ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤.

**–ü—Ä–∏–º–µ—Ä –∏–∑ 002_row_level_security.sql:**
```sql
-- –°—Ç—Ä–æ–∫–∏ 163-168
USING (
    EXISTS (
        SELECT 1 FROM sessions
        WHERE sessions.id = clinical_notes.session_id
        AND sessions.clinic_id = get_user_clinic_id()
    )
);
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç —Å–æ—Å—Ç–∞–≤–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ –Ω–∞ `(id, clinic_id)` –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã `sessions`.

**–†–µ—à–µ–Ω–∏–µ:**
```sql
CREATE INDEX IF NOT EXISTS idx_sessions_id_clinic_id 
ON sessions(id, clinic_id);
-- –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π idx_sessions_clinic_id –µ—Å–ª–∏ –æ–Ω –ø–æ–∫—Ä—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å
```

---

### 6. –§—É–Ω–∫—Ü–∏—è `get_user_clinic_id()` –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å NULL –±–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** –í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ø–æ–ª–∏—Ç–∏–∫–∞—Ö –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å NULL.

**–ü—Ä–∏–º–µ—Ä –∏–∑ 008_fix_profile_loading_performance.sql:**
```sql
-- –°—Ç—Ä–æ–∫–∏ 78-80
USING (
    get_user_clinic_id() IS NOT NULL
    AND id = get_user_clinic_id()
);
```

**–•–æ—Ä–æ—à–æ:** –ó–¥–µ—Å—å NULL –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ.

**–ü–ª–æ—Ö–æ:** –í –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö (002_row_level_security.sql) –º–æ–∂–µ—Ç –±—ã—Ç—å:
```sql
USING (id = get_user_clinic_id());  -- NULL = NULL –≤–µ—Ä–Ω—ë—Ç false, –Ω–æ –Ω–µ—è–≤–Ω–æ
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í—Å–µ–≥–¥–∞ —è–≤–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å NULL, –µ—Å–ª–∏ —ç—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –ª–æ–≥–∏–∫–∏.

---

### 7. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –Ω–∞ `consent_records` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–≥–ª–∞—Å–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞:** –§—É–Ω–∫—Ü–∏—è `has_active_consent()` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ RLS –ø–æ–ª–∏—Ç–∏–∫–∞—Ö, –Ω–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–æ–π.

**–§–∞–π–ª:** 005_mfa_and_security.sql, —Å—Ç—Ä–æ–∫–∏ 174-181

**–¢–µ–∫—É—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã (004_audit_and_compliance.sql):**
- `idx_consent_records_patient_id`
- `idx_consent_records_type`
- `idx_consent_records_status`
- `idx_consent_records_expires_at`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Ç —Å–æ—Å—Ç–∞–≤–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ –¥–ª—è —Ç–∏–ø–∏—á–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞:
```sql
WHERE patient_id = patient_uuid
AND consent_type = consent_type_param
AND status = 'active'
AND (expires_at IS NULL OR expires_at > NOW())
```

**–†–µ—à–µ–Ω–∏–µ:**
```sql
CREATE INDEX IF NOT EXISTS idx_consent_records_lookup 
ON consent_records(patient_id, consent_type, status, expires_at)
WHERE status = 'active';
```

---

### 8. –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å `cleanup_expired_data()`

**–ü—Ä–æ–±–ª–µ–º–∞:** –§—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ DELETE –±–µ–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

**–§–∞–π–ª:** 007_enhanced_security.sql, —Å—Ç—Ä–æ–∫–∏ 259-368

**–†–∏—Å–∫–∏:**
- –ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–µ—Ä–≤—ë—Ç—Å—è –ø–æ—Å–µ—Ä–µ–¥–∏–Ω–µ, —á–∞—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞, –∞ —á–∞—Å—Ç—å –Ω–µ—Ç
- –ù–µ—Ç –æ—Ç–∫–∞—Ç–∞ (rollback) –ø—Ä–∏ –æ—à–∏–±–∫–µ
- –ú–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω–æ–π –¥–ª—è –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö

**–†–µ—à–µ–Ω–∏–µ:**
```sql
-- –û–±–µ—Ä–Ω—É—Ç—å –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é (—É–∂–µ –µ—Å—Ç—å, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è)
-- –ù–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫:
BEGIN
    -- ... —É–¥–∞–ª–µ–Ω–∏—è ...
EXCEPTION WHEN OTHERS THEN
    -- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É
    PERFORM log_audit_event(...);
    RAISE;
END;
```

**–¢–∞–∫–∂–µ:** –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `pg_cron` –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏.

---

## üü¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 9. –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö JOIN

**–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã:**
- `sessions.clinic_id` + `sessions.id` (—Å–æ—Å—Ç–∞–≤–Ω–æ–π)
- `clinical_notes.session_id` + `clinical_notes.user_id` (—Å–æ—Å—Ç–∞–≤–Ω–æ–π)
- `documents.patient_id` + `documents.uploaded_by` (—Å–æ—Å—Ç–∞–≤–Ω–æ–π)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å `EXPLAIN ANALYZE` –¥–ª—è —Ç–∏–ø–∏—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã.

---

### 10. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ `verify_backup_code()`

**–ü—Ä–æ–±–ª–µ–º–∞:** –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–∞–±–ª–∏—Ü—É –ø—Ä–∏ –∫–∞–∂–¥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–æ–¥–∞.

**–§–∞–π–ª:** 007_enhanced_security.sql, —Å—Ç—Ä–æ–∫–∏ 178-181

```sql
UPDATE profiles
SET backup_codes_hashed = array_remove(backup_codes_hashed, v_code),
    updated_at = NOW()
WHERE id = user_uuid;
```

**–ü—Ä–æ–±–ª–µ–º–∞:** –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —É–∑–∫–∏–º –º–µ—Å—Ç–æ–º –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ.

**–†–µ—à–µ–Ω–∏–µ:** –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–¥–æ–≤ –∏–ª–∏ batch-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.

---

### 11. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–∞–±–ª–∏—Ü –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–µ–π

**–•–æ—Ä–æ—à–æ:** –í 008_fix_profile_loading_performance.sql –µ—Å—Ç—å:
```sql
ANALYZE profiles;
ANALYZE clinics;
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å `autovacuum` –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:
```sql
ALTER TABLE profiles SET (autovacuum_analyze_scale_factor = 0.05);
ALTER TABLE clinics SET (autovacuum_analyze_scale_factor = 0.05);
```

---

### 12. –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å `handle_new_user()` trigger

**–ü—Ä–æ–±–ª–µ–º–∞:** –¢—Ä–∏–≥–≥–µ—Ä –ª–æ–≤–∏—Ç –≤—Å–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∏ —Ç–æ–ª—å–∫–æ –ª–æ–≥–∏—Ä—É–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ.

**–§–∞–π–ª:** 006_fix_user_creation_trigger.sql, —Å—Ç—Ä–æ–∫–∏ 36-40

```sql
EXCEPTION WHEN OTHERS THEN
    RAISE WARNING 'Error creating profile for user %: %', NEW.id, SQLERRM;
    RETURN NEW;
```

**–†–∏—Å–∫:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –≤ `auth.users`, –Ω–æ –ø—Ä–æ—Ñ–∏–ª—å –Ω–µ —Å–æ–∑–¥–∞—Å—Ç—Å—è, —á—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –ø—Ä–æ–±–ª–µ–º–∞–º —Å RLS.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** 
- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –æ—à–∏–±–æ–∫
- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç–∞–∫–∏—Ö —Å–ª—É—á–∞–µ–≤
- –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å retry –º–µ—Ö–∞–Ω–∏–∑–º

---

## üîµ –í–æ–ø—Ä–æ—Å—ã —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏

### 13. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ NULL –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö

**–ü—Ä–∏–º–µ—Ä:** `create_clinic_for_onboarding()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç `v_user_id IS NULL`, –Ω–æ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç `SELECT`.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å, —á—Ç–æ SELECT –≤–µ—Ä–Ω—É–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
```sql
SELECT clinic_id INTO STRICT v_existing_clinic_id
FROM profiles
WHERE id = v_user_id;

-- –ò–ª–∏:
IF NOT FOUND THEN
    -- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª—É—á–∞—è –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –ø—Ä–æ—Ñ–∏–ª—è
END IF;
```

---

### 14. –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ deadlocks

**–†–∏—Å–∫:** –§—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –æ–±–Ω–æ–≤–ª—è—é—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∞–±–ª–∏—Ü, –º–æ–≥—É—Ç –≤—ã–∑–≤–∞—Ç—å deadlock.

**–ü—Ä–∏–º–µ—Ä:** `create_clinic_for_onboarding()`:
1. –ß–∏—Ç–∞–µ—Ç `profiles`
2. –í—Å—Ç–∞–≤–ª—è–µ—Ç –≤ `clinics`
3. –û–±–Ω–æ–≤–ª—è–µ—Ç `profiles`

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è—Ç—å —Ç–∞–±–ª–∏—Ü—ã –≤ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–º –ø–æ—Ä—è–¥–∫–µ –≤–æ –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö.

---

### 15. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç –≤—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.

**–ü—Ä–∏–º–µ—Ä:** `create_clinic_for_onboarding()`:
```sql
CREATE OR REPLACE FUNCTION create_clinic_for_onboarding(
    clinic_name VARCHAR(255),  -- –ú–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º –∏–ª–∏ NULL?
    ...
)
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```sql
IF clinic_name IS NULL OR trim(clinic_name) = '' THEN
    RAISE EXCEPTION 'Clinic name cannot be empty';
END IF;
```

---

## üìä –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–±–ª–µ–º

| –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –ü—Ä–æ–±–ª–µ–º–∞ | –§–∞–π–ª | –°—Ç—Ä–æ–∫–∏ | –°—Ç–∞—Ç—É—Å |
|-----------|----------|------|--------|--------|
| üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ | Race condition –≤ create_clinic_for_onboarding | 009 | 34-45 | –¢—Ä–µ–±—É–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è |
| üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ | –ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è RLS –ø–æ–ª–∏—Ç–∏–∫–∞ | 009 | 88-97 | –¢—Ä–µ–±—É–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ |
| üü° –í–∞–∂–Ω–æ | –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã get_user_clinic_id() | 002 | –ú–Ω–æ–∂–µ—Å—Ç–≤–æ | –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è |
| üü° –í–∞–∂–Ω–æ | –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –Ω–∞ profiles.role | 002 | 26 | –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å |
| üü° –í–∞–∂–Ω–æ | –ù–µ–æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ EXISTS –≤ RLS | 002 | 163-168 | –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è |
| üü° –í–∞–∂–Ω–æ | –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–æ—Å—Ç–∞–≤–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ –¥–ª—è consent | 004/005 | - | –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å |
| üü¢ –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ | –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è verify_backup_code | 007 | 178-181 | –ú–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å |
| üü¢ –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ | –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö | 009 | 11-16 | –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å |

---

## ‚úÖ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ —Ö–æ—Ä–æ—à–æ

1. ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `STABLE` –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π RLS (008)
2. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (008)
3. ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç–∏—á–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ (WHERE clauses)
4. ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ NULL –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–µ—Å—Ç–∞—Ö (008)
5. ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `SECURITY DEFINER` –¥–ª—è –æ–±—Ö–æ–¥–∞ RLS –≥–¥–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
6. ‚úÖ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ —Ñ—É–Ω–∫—Ü–∏—è–º –∏ –ø–æ–ª–∏—Ç–∏–∫–∞–º

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º

### –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ (–∫—Ä–∏—Ç–∏—á–Ω–æ):
1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å race condition –≤ `create_clinic_for_onboarding()` - –¥–æ–±–∞–≤–∏—Ç—å `FOR UPDATE` –∏–ª–∏ advisory lock
2. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å RLS –ø–æ–ª–∏—Ç–∏–∫—É –≤ 009 - –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –¥–≤–∞ EXISTS –≤ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å

### –í –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è (–≤–∞–∂–Ω–æ):
3. –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å –Ω–∞ `profiles.role`
4. –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Å—Ç–∞–≤–Ω–æ–π –∏–Ω–¥–µ–∫—Å –¥–ª—è `consent_records`
5. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –≤—ã–∑–æ–≤—ã `get_user_clinic_id()` –≤ –ø–æ–ª–∏—Ç–∏–∫–∞—Ö

### –í –±—É–¥—É—â–µ–º (–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ):
6. –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤–æ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏
7. –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –≤ —Ç—Ä–∏–≥–≥–µ—Ä–∞—Ö
8. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

---

## üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å RLS –ø–æ–ª–∏—Ç–∏–∫
RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏, –ø–æ—ç—Ç–æ–º—É –≤–∞–∂–Ω–æ:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å—ã –≤–µ–∑–¥–µ, –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ
- –ò–∑–±–µ–≥–∞—Ç—å —Å–ª–æ–∂–Ω—ã—Ö –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–≤ –≤ USING clauses
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `STABLE` —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:
- –ú–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (pg_stat_statements)
- Deadlocks (–ª–æ–≥–∏ PostgreSQL)
- –û—à–∏–±–æ–∫ –≤ —Ç—Ä–∏–≥–≥–µ—Ä–∞—Ö (–æ—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ª–æ–≥–æ–≤)

---

**–ê–≤—Ç–æ—Ä —Ä–µ–≤—å—é:** AI Code Reviewer  
**–î–∞—Ç–∞:** 2024


