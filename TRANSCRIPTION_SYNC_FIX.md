# Исправление проблемы: транскрипция висит в обработке

## Проблема
Транскрипция завершалась в AssemblyAI, но не обновлялась в приложении, оставаясь в статусе "обработка".

## Решение
Добавлена автоматическая синхронизация статуса транскрипции напрямую из AssemblyAI API.

## Что было сделано

### 1. Backend изменения

#### Новый endpoint для синхронизации
- **POST** `/api/transcribe/:recordingId/sync` - принудительная синхронизация статуса из AssemblyAI

#### Улучшен существующий endpoint
- **GET** `/api/transcribe/:recordingId/status` - теперь автоматически синхронизирует статус, если:
  - Транскрипция в статусе "processing" более 30 секунд
  - Или добавлен параметр `?sync=true`

### 2. Frontend изменения

#### Автоматическая синхронизация при polling
- Через 30 секунд после начала транскрипции (15 попыток polling)
- Каждые 10 попыток, если транскрипция все еще в статусе "processing"

#### Новые функции
- `syncTranscriptionStatus()` - синхронизация статуса вручную
- `getRecordingStatus()` - теперь поддерживает автоматическую синхронизацию

## Как это работает

1. **Автоматически**: 
   - Приложение проверяет статус каждые 2 секунды
   - Через 30 секунд начинает синхронизировать с AssemblyAI
   - Если транскрипция завершена в AssemblyAI, результат сразу сохраняется

2. **Вручную** (если нужно):
   - Можно вызвать синхронизацию через API endpoint
   - Или добавить кнопку в UI (если нужно)

## Что делать сейчас

### Для существующей записи, которая висит в обработке:

1. **Перезагрузите страницу "Сессии"** - синхронизация произойдет автоматически при следующей проверке статуса

2. **Или подождите** - автоматическая синхронизация сработает через 30 секунд после начала транскрипции

3. **Или перезапустите backend сервис** для применения изменений:
   ```bash
   cd backend/transcription-service
   npm start
   ```

### Для новых записей:
- Все будет работать автоматически
- Синхронизация произойдет сама, если транскрипция затянется

## Технические детали

### Backend логика синхронизации:
1. Берет `transcript_id` из записи в БД
2. Запрашивает статус напрямую из AssemblyAI API
3. Если транскрипция завершена:
   - Сохраняет текст с диаризацией
   - Обновляет статус на 'completed'
   - Устанавливает `transcribed_at`

### Frontend логика:
1. Polling каждые 2 секунды
2. После 15 попыток (30 секунд) начинает синхронизировать
3. Каждые 10 попыток после этого делает принудительную синхронизацию

## Преимущества

✅ **Работает без webhook** - не нужно настраивать ngrok или публичный URL  
✅ **Автоматическое восстановление** - если webhook не сработал, статус все равно обновится  
✅ **Быстрая реакция** - результат появляется сразу после завершения в AssemblyAI  
✅ **Надежность** - двойная проверка (polling + sync)  

## Примечание

Webhook по-прежнему рекомендуется для production, но система теперь работает и без него. Синхронизация используется как fallback механизм.


