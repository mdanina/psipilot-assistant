# –ü–ª–∞–Ω –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

## üéØ –°—Ç—Ä–∞—Ç–µ–≥–∏—è: –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –±–µ–∑ –ø–æ–ª–æ–º–æ–∫

**–ü—Ä–∏–Ω—Ü–∏–ø—ã:**
1. ‚úÖ –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã
2. ‚úÖ –°—Ç–∞—Ä—ã–π –∫–æ–¥ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
3. ‚úÖ –ù–æ–≤—ã–π –∫–æ–¥ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
4. ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –ø–æ –æ–¥–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ/–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—É
5. ‚úÖ –ú–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç

---

## üî¥ –ü—Ä–æ–±–ª–µ–º–∞ 1: React Query –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

### –¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:
```typescript
// src/App.tsx:27
const queryClient = new QueryClient(); // ‚ùå –ù–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
```

### ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–®–∞–≥ 1):

**1.1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å QueryClient –ë–ï–ó –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤**

–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `src/lib/query-client.ts`:

```typescript
import { QueryClient } from '@tanstack/react-query';

// ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è - –Ω–µ –ª–æ–º–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥
export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      // –ö–µ—à–∏—Ä—É–µ–º –Ω–∞ 5 –º–∏–Ω—É—Ç (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ)
      staleTime: 5 * 60 * 1000,
      // –•—Ä–∞–Ω–∏–º –≤ –∫–µ—à–µ 10 –º–∏–Ω—É—Ç
      cacheTime: 10 * 60 * 1000,
      // –ù–µ —Ä–µ—Ñ–µ—Ç—á–∏—Ç—å –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –æ–∫–Ω–∞ (—á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é)
      refetchOnWindowFocus: false,
      // –ù–µ —Ä–µ—Ñ–µ—Ç—á–∏—Ç—å –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ (—á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞—Ç—å)
      refetchOnReconnect: false,
      // –ü–æ–≤—Ç–æ—Ä—è—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–µ (3 –ø–æ–ø—ã—Ç–∫–∏)
      retry: 3,
      retryDelay: (attemptIndex) => Math.min(1000 * 2 ** attemptIndex, 30000),
    },
    mutations: {
      // –ü–æ–≤—Ç–æ—Ä—è—Ç—å –º—É—Ç–∞—Ü–∏–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
      retry: 1,
    },
  },
});
```

**1.2. –û–±–Ω–æ–≤–∏—Ç—å App.tsx (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ):**

```typescript
// src/App.tsx
import { queryClient } from '@/lib/query-client'; // ‚úÖ –ò–º–ø–æ—Ä—Ç –∏–∑ –Ω–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞

// –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô
const App = () => (
  <ThemeProvider>
    <QueryClientProvider client={queryClient}>
      {/* ... –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */}
    </QueryClientProvider>
  </ThemeProvider>
);
```

**‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, —Å—Ç–∞—Ä—ã–π –∫–æ–¥ –Ω–µ —Å–ª–æ–º–∞–Ω!

---

### ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ (–®–∞–≥ 2): –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

**2.1. –°–æ–∑–¥–∞—Ç—å wrapper hook –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏**

–°–æ–∑–¥–∞—Ç—å `src/hooks/usePatients.ts`:

```typescript
import { useQuery } from '@tanstack/react-query';
import { getPatients, type DecryptedPatient } from '@/lib/supabase-patients';

// ‚úÖ –ù–æ–≤—ã–π hook —Å React Query, –Ω–æ —Å—Ç–∞—Ä—ã–π API —Ä–∞–±–æ—Ç–∞–µ—Ç
export function usePatients() {
  return useQuery<DecryptedPatient[], Error>({
    queryKey: ['patients'],
    queryFn: async () => {
      const { data, error } = await getPatients();
      if (error) throw error;
      return data || [];
    },
    // –ö–µ—à –Ω–∞ 5 –º–∏–Ω—É—Ç
    staleTime: 5 * 60 * 1000,
  });
}
```

**2.2. –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å PatientsPage –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ**

```typescript
// src/pages/PatientsPage.tsx

// ‚úÖ –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π hook (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
import { usePatients } from '@/hooks/usePatients';

const PatientsPage = () => {
  // ‚úÖ –ù–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥ —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
  const { data: patients = [], isLoading, error, refetch } = usePatients();
  
  // ‚úÖ –°—Ç–∞—Ä—ã–π –∫–æ–¥ –¥–ª—è documentCounts –ø–æ–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ
  const [documentCounts, setDocumentCounts] = useState<{[key: string]: number}>({});
  
  // –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô
  // ...
};

// ‚úÖ –í–∞—Ä–∏–∞–Ω—Ç 2: –û—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∞—Ä—ã–π –∫–æ–¥ (fallback)
// –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫, –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫:
// const [patients, setPatients] = useState<PatientWithDocuments[]>([]);
// const loadPatients = useCallback(async () => { ... }, []);
```

**‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç:** 
- –ù–æ–≤—ã–π –∫–æ–¥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- –°—Ç–∞—Ä—ã–π –∫–æ–¥ –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç
- –ù–∏—á–µ–≥–æ –Ω–µ —Å–ª–æ–º–∞–Ω–æ

---

## üî¥ –ü—Ä–æ–±–ª–µ–º–∞ 2: N+1 –∑–∞–ø—Ä–æ—Å—ã (–ø–∞—Ü–∏–µ–Ω—Ç—ã + –¥–æ–∫—É–º–µ–Ω—Ç—ã)

### –¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:
```typescript
// src/pages/PatientsPage.tsx:75-76
const { data, error } = await getPatients();
const documentCounts = await getPatientDocumentCounts(patientIds); // ‚ùå –û—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å
```

### ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:

**–°–æ–∑–¥–∞—Ç—å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –ë–ï–ó –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ä–æ–π:**

```typescript
// src/lib/supabase-patients.ts

// ‚úÖ –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Å—Ç–∞–µ—Ç—Å—è (–æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å)
export async function getPatients(): Promise<{...}> {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô
}

// ‚úÖ –ù–æ–≤–∞—è –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ)
export async function getPatientsWithDocumentCounts(): Promise<{
  data: (DecryptedPatient & { documentCount: number })[] | null;
  error: Error | null;
}> {
  try {
    // 1. –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
    const { data: patients, error } = await getPatients();
    if (error || !patients) {
      return { data: null, error: error || new Error('No patients') };
    }

    // 2. –û–î–ò–ù –∑–∞–ø—Ä–æ—Å –¥–ª—è –≤—Å–µ—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
    const patientIds = patients.map(p => p.id);
    if (patientIds.length === 0) {
      return { 
        data: patients.map(p => ({ ...p, documentCount: 0 })), 
        error: null 
      };
    }

    // ‚úÖ –û–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ N –∑–∞–ø—Ä–æ—Å–æ–≤
    const { data: documents, error: docsError } = await supabase
      .from('documents')
      .select('patient_id')
      .in('patient_id', patientIds);

    if (docsError) {
      console.warn('Error fetching document counts:', docsError);
      // ‚úÖ Fallback: –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ –±–µ–∑ —Å—á–µ—Ç—á–∏–∫–æ–≤
      return { 
        data: patients.map(p => ({ ...p, documentCount: 0 })), 
        error: null 
      };
    }

    // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç—ã
    const counts: { [key: string]: number } = {};
    patientIds.forEach(id => counts[id] = 0);
    documents?.forEach(doc => {
      if (doc.patient_id) {
        counts[doc.patient_id] = (counts[doc.patient_id] || 0) + 1;
      }
    });

    // –û–±—ä–µ–¥–∏–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
    const patientsWithCounts = patients.map(p => ({
      ...p,
      documentCount: counts[p.id] || 0,
    }));

    return { data: patientsWithCounts, error: null };
  } catch (error) {
    return { data: null, error: error as Error };
  }
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):**

```typescript
// src/pages/PatientsPage.tsx

// ‚úÖ –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é
const loadPatients = useCallback(async () => {
  if (!profile?.clinic_id) {
    setIsLoading(false);
    return;
  }

  try {
    setIsLoading(true);
    
    // ‚úÖ –ù–æ–≤–∞—è –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è (–æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ –¥–≤—É—Ö)
    const { data, error } = await getPatientsWithDocumentCounts();
    
    // ‚úÖ –ò–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∞—Ä—ã–π –∫–æ–¥ (—Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ)
    // const { data: patientsData, error } = await getPatients();
    // const documentCounts = await getPatientDocumentCounts(patientIds);
    
    if (error) {
      toast({ title: "–û—à–∏–±–∫–∞", description: error.message, variant: "destructive" });
      return;
    }

    if (!data) {
      setPatients([]);
      setFilteredPatients([]);
      return;
    }

    setPatients(data);
    setFilteredPatients(data);
  } catch (error) {
    // ... –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
  } finally {
    setIsLoading(false);
  }
}, [profile?.clinic_id, toast]);
```

**‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ
- –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
- –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É –Ω–∏–º–∏
- –ù–∏—á–µ–≥–æ –Ω–µ —Å–ª–æ–º–∞–Ω–æ

---

## üî¥ –ü—Ä–æ–±–ª–µ–º–∞ 3: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ backend

### ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ:

**–î–æ–±–∞–≤–∏—Ç—å –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ë–ï–ó –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ä–æ—É—Ç–æ–≤:**

```javascript
// backend/transcription-service/middleware/cache.js

// ‚úÖ –ü—Ä–æ—Å—Ç–æ–π in-memory –∫–µ—à (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ Redis –ø–æ–∑–∂–µ)
const cache = new Map();
const CACHE_TTL = 5 * 60 * 1000; // 5 –º–∏–Ω—É—Ç

function getCacheKey(req) {
  return `${req.method}:${req.originalUrl}`;
}

function getCached(key) {
  const cached = cache.get(key);
  if (!cached) return null;
  
  if (Date.now() > cached.expiresAt) {
    cache.delete(key);
    return null;
  }
  
  return cached.data;
}

function setCache(key, data) {
  cache.set(key, {
    data,
    expiresAt: Date.now() + CACHE_TTL,
  });
}

// ‚úÖ Middleware –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
export function cacheMiddleware(options = {}) {
  return (req, res, next) => {
    // ‚úÖ –ö–µ—à–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ GET –∑–∞–ø—Ä–æ—Å—ã
    if (req.method !== 'GET') {
      return next();
    }

    // ‚úÖ –ú–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –∫–µ—à —á–µ—Ä–µ–∑ query –ø–∞—Ä–∞–º–µ—Ç—Ä ?no-cache=true
    if (req.query['no-cache'] === 'true') {
      return next();
    }

    const cacheKey = getCacheKey(req);
    const cached = getCached(cacheKey);

    if (cached) {
      // ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–∑ –∫–µ—à–∞
      return res.json(cached);
    }

    // ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π res.json
    const originalJson = res.json.bind(res);
    res.json = function(data) {
      // ‚úÖ –ö–µ—à–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —É—Å–ø–µ—à–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
      if (res.statusCode === 200) {
        setCache(cacheKey, data);
      }
      return originalJson(data);
    };

    next();
  };
}
```

**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω—É–∂–Ω—ã—Ö —Ä–æ—É—Ç–æ–≤):**

```javascript
// backend/transcription-service/routes/ai.js

import { cacheMiddleware } from '../middleware/cache.js';

// ‚úÖ –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–µ—à —Ç–æ–ª—å–∫–æ –∫ GET –∑–∞–ø—Ä–æ—Å–∞–º —à–∞–±–ª–æ–Ω–æ–≤
router.get('/block-templates', cacheMiddleware(), async (req, res) => {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô
});

router.get('/note-templates', cacheMiddleware(), async (req, res) => {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô
});

// ‚úÖ POST –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ (–±–µ–∑ –∫–µ—à–∞)
router.post('/generate', async (req, res) => {
  // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô
});
```

**‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è GET –∑–∞–ø—Ä–æ—Å–æ–≤
- –ú–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å —á–µ—Ä–µ–∑ `?no-cache=true`
- POST/PUT/DELETE —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ
- –ù–∏—á–µ–≥–æ –Ω–µ —Å–ª–æ–º–∞–Ω–æ

---

## üìã –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏ (–ø–æ—à–∞–≥–æ–≤–æ)

### –ù–µ–¥–µ–ª—è 1: –ë–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ (–±–µ–∑–æ–ø–∞—Å–Ω–æ)

**–î–µ–Ω—å 1-2:**
1. ‚úÖ –°–æ–∑–¥–∞—Ç—å `src/lib/query-client.ts` —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
2. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å `src/App.tsx` (1 —Å—Ç—Ä–æ–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
3. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å - –≤—Å–µ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ —Ä–∞–Ω—å—à–µ

**–î–µ–Ω—å 3-4:**
4. ‚úÖ –°–æ–∑–¥–∞—Ç—å `src/hooks/usePatients.ts` (–Ω–æ–≤—ã–π hook)
5. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å hook –æ—Ç–¥–µ–ª—å–Ω–æ
6. ‚úÖ –ù–ï –ø—Ä–∏–º–µ–Ω—è—Ç—å –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö –ø–æ–∫–∞

**–î–µ–Ω—å 5:**
7. ‚úÖ –°–æ–∑–¥–∞—Ç—å `getPatientsWithDocumentCounts()` (–Ω–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
8. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–¥–µ–ª—å–Ω–æ
9. ‚úÖ –ù–ï –ø—Ä–∏–º–µ–Ω—è—Ç—å –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö –ø–æ–∫–∞

### –ù–µ–¥–µ–ª—è 2: –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è (–ø–æ –æ–¥–Ω–æ–º—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—É)

**–î–µ–Ω—å 1-2: –ú–∏–≥—Ä–∞—Ü–∏—è PatientsPage**
1. ‚úÖ –ó–∞–º–µ–Ω–∏—Ç—å `loadPatients` –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `usePatients` hook
2. ‚úÖ –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ `getPatientsWithDocumentCounts`
3. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
4. ‚úÖ –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - –æ—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è (git revert)

**–î–µ–Ω—å 3-4: –ú–∏–≥—Ä–∞—Ü–∏—è SessionsPage**
1. ‚úÖ –°–æ–∑–¥–∞—Ç—å `useSessions` hook
2. ‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ
3. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

**–î–µ–Ω—å 5: Backend –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ**
1. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å cache middleware
2. ‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ –∫ GET /block-templates
3. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
4. ‚úÖ –ï—Å–ª–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç - –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∫ –¥—Ä—É–≥–∏–º GET —Ä–æ—É—Ç–∞–º

### –ù–µ–¥–µ–ª—è 3: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

1. ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
2. ‚úÖ –ò–∑–º–µ—Ä–µ–Ω–∏–µ —É–ª—É—á—à–µ–Ω–∏–π
3. ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

---

## üõ°Ô∏è –°—Ç—Ä–∞—Ç–µ–≥–∏—è –æ—Ç–∫–∞—Ç–∞

### –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫:

**–í–∞—Ä–∏–∞–Ω—Ç 1: –û—Ç–∫–∞—Ç —á–µ—Ä–µ–∑ Git**
```bash
git revert <commit-hash>
```

**–í–∞—Ä–∏–∞–Ω—Ç 2: Feature flag**
```typescript
// src/lib/query-client.ts
const USE_REACT_QUERY = process.env.VITE_USE_REACT_QUERY !== 'false';

export const queryClient = USE_REACT_QUERY 
  ? new QueryClient({ /* –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è */ })
  : new QueryClient(); // –°—Ç–∞—Ä–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```

**–í–∞—Ä–∏–∞–Ω—Ç 3: –£—Å–ª–æ–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**
```typescript
// src/pages/PatientsPage.tsx
const USE_NEW_APPROACH = false; // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å

if (USE_NEW_APPROACH) {
  // –ù–æ–≤—ã–π –∫–æ–¥
  const { data } = usePatients();
} else {
  // –°—Ç–∞—Ä—ã–π –∫–æ–¥ (—Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ)
  const [patients, setPatients] = useState([]);
  const loadPatients = useCallback(async () => { ... });
}
```

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

–ü–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º:

- [ ] –°–æ–∑–¥–∞–Ω backup/commit —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- [ ] –ù–æ–≤—ã–π –∫–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —Å–æ —Å—Ç–∞—Ä—ã–º
- [ ] –°—Ç–∞—Ä—ã–π –∫–æ–¥ –º–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ dev –æ–∫—Ä—É–∂–µ–Ω–∏–∏
- [ ] –ù–µ—Ç breaking changes –≤ API
- [ ] –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞

---

## üéØ –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

–ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏:

- ‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –£–ª—É—á—à–µ–Ω–∏–µ –Ω–∞ 60-80%
- ‚úÖ **–ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î:** –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞ 70%
- ‚úÖ **–í—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏:** –£–ª—É—á—à–µ–Ω–∏–µ –Ω–∞ 50-70%
- ‚úÖ **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å:** –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–∏–ª–∏ –ª—É—á—à–µ)
- ‚úÖ **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** 100%

---

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω—ã (—Å—Ç–∞—Ä—ã–π –∫–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç)
- ‚úÖ –û–±—Ä–∞—Ç–∏–º—ã (–º–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å)
- ‚úÖ –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã (–ø–æ –æ–¥–Ω–æ–º—É –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—É)
- ‚úÖ –¢–µ—Å—Ç–∏—Ä—É–µ–º—ã (–º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ)

**–ù–∏—á–µ–≥–æ –Ω–µ —Å–ª–æ–º–∞–µ—Ç—Å—è, –µ—Å–ª–∏ —Å–ª–µ–¥–æ–≤–∞—Ç—å –ø–ª–∞–Ω—É!**

