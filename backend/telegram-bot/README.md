# PsiPilot Telegram Bot

Telegram бот для приема жалоб и обращений от пользователей платформы PsiPilot.

## Функционал

- Прием обращений по категориям (ошибки, предложения, жалобы, вопросы)
- Сбор контактных данных для обратной связи
- Поддержка вложений (фото, документы, видео)
- Сохранение обращений в базу данных
- Уведомление администраторов в Telegram группу
- Просмотр статуса своих обращений

## Настройка

### 1. Создание бота в Telegram

1. Откройте [@BotFather](https://t.me/BotFather) в Telegram
2. Отправьте команду `/newbot`
3. Следуйте инструкциям для создания бота
4. Сохраните полученный токен

### 2. Настройка группы администраторов (опционально)

Чтобы получать уведомления о новых обращениях:

1. Создайте группу в Telegram
2. Добавьте бота в группу и сделайте его администратором
3. Отправьте любое сообщение в группу
4. Получите Chat ID группы:
   ```
   https://api.telegram.org/bot<TOKEN>/getUpdates
   ```
   Найдите `"chat":{"id":-100...}` в ответе

### 3. Переменные окружения

```env
# Токен бота (обязательно)
TELEGRAM_BOT_TOKEN=1234567890:ABCdefGHIjklMNOpqrsTUVwxyz

# URL Supabase (обязательно)
SUPABASE_URL=https://your-supabase.com

# Service Role Key Supabase (обязательно)
SUPABASE_SERVICE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# Chat ID для уведомлений (опционально)
TELEGRAM_ADMIN_CHAT_ID=-1001234567890
```

### 4. Применение миграции БД

Выполните миграцию `057_complaints_table.sql` для создания таблицы обращений:

```bash
# Если используете Supabase CLI
supabase db push

# Или вручную через SQL редактор в Dashboard
```

## Запуск

### Локально

```bash
cd backend/telegram-bot
npm install
npm run dev
```

### Docker

```bash
docker-compose -f docker-compose.prod.yml up -d telegram-bot
```

## Команды бота

| Команда | Описание |
|---------|----------|
| `/start` | Приветствие и информация о боте |
| `/new` | Создать новое обращение |
| `/status` | Посмотреть статус своих обращений |
| `/cancel` | Отменить текущее обращение |
| `/help` | Справка по командам |

## Схема работы

```
1. Пользователь запускает /new
2. Выбирает категорию обращения
3. Вводит текст сообщения
4. Указывает контакт (опционально)
5. Прикрепляет файлы (опционально)
6. Подтверждает отправку
7. Обращение сохраняется в БД
8. Администраторы получают уведомление
```

## Структура таблицы complaints

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | UUID | Уникальный идентификатор |
| `telegram_user_id` | BIGINT | ID пользователя Telegram |
| `telegram_username` | VARCHAR | Username в Telegram |
| `category` | ENUM | Категория (bug, feature, complaint, question, other) |
| `message` | TEXT | Текст обращения |
| `contact_info` | VARCHAR | Контакт для связи |
| `attachments` | JSONB | Массив вложений |
| `status` | ENUM | Статус (new, in_progress, resolved, closed) |
| `created_at` | TIMESTAMP | Дата создания |

## Безопасность

- Бот использует Service Role Key для записи в БД
- RLS политики ограничивают доступ к обращениям только для админов
- Вложения хранятся как file_id Telegram (не загружаются на сервер)
